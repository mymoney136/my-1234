<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>×”×›×¡×£ ×©×œ×™ â€” v1.01</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root{
            --glass-bg: rgba(255,255,255,0.06);
            --glass-border: rgba(255,255,255,0.12);
            --accent: #7EE7C7;
            --muted: #9AA4B2;
            --glass-blur: 14px;
            --card-shadow: 0 12px 40px rgba(2,6,23,0.6);
            --opacity: 1;
        }

        @keyframes floatSlow {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-4px); }
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(126,231,199,0.1); }
            50% { box-shadow: 0 0 40px rgba(126,231,199,0.25); }
        }

        @keyframes fadeIn {
            from { opacity:0; }
            to { opacity:1; }
        }

        *{box-sizing:border-box;transition:color .18s,background .18s,border-color .18s,box-shadow .18s,transform .12s}
        html,body{height:100%;margin:0;font-family:'Rubik','Inter',system-ui,Segoe UI,Roboto,Arial;color:#e9eef6;background:linear-gradient(135deg, #0a1420 0%, #0f1a2a 50%, #081426 100%);background-size:400% 400%;animation:gradientShift 30s ease infinite;-webkit-font-smoothing:antialiased;background-attachment:fixed;position:relative}
        
        body::before {
            content:'';
            position:fixed;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background-image:
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(126,231,199,0.03) 2px, rgba(126,231,199,0.03) 4px),
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(126,231,199,0.02) 2px, rgba(126,231,199,0.02) 4px);
            pointer-events:none;
            z-index:1;
        }

        /* Layout */
        .page{min-height:100vh;display:flex;flex-direction:column;position:relative;z-index:2}
        .topbar{display:flex;justify-content:space-between;align-items:center;padding:14px 22px;gap:16px;background:rgba(7,16,32,0.4);backdrop-filter:blur(12px);border-bottom:1px solid rgba(126,231,199,0.1);animation:floatSlow 12s ease-in-out infinite}

        /* Glass panel */
        .glass{backdrop-filter:blur(var(--glass-blur));background:linear-gradient(135deg, rgba(255,255,255,calc(0.04 * var(--opacity))), rgba(126,231,199,calc(0.02 * var(--opacity))));border-radius:14px;padding:10px;border:1px solid rgba(126,231,199,calc(0.15 * var(--opacity)));box-shadow:inset 0 1px 0 rgba(255,255,255,calc(0.08 * var(--opacity))), 0 8px 32px rgba(126,231,199,calc(0.08 * var(--opacity)));transition:all .3s cubic-bezier(0.4, 0, 0.2, 1)}
        .glass:hover{border-color:rgba(126,231,199,calc(0.25 * var(--opacity)));box-shadow:inset 0 1px 0 rgba(255,255,255,calc(0.1 * var(--opacity))), 0 12px 40px rgba(126,231,199,calc(0.15 * var(--opacity)))}
        
        .card{width:100%;max-width:1100px;padding:28px;border-radius:18px;box-shadow:0 25px 50px -12px rgba(2,6,23,0.8),inset 0 1px 0 rgba(255,255,255,0.08);background:linear-gradient(135deg, rgba(255,255,255,calc(0.03 * var(--opacity))), rgba(126,231,199,calc(0.015 * var(--opacity))));border:1px solid rgba(126,231,199,calc(0.12 * var(--opacity)));animation:floatSlow 16s ease-in-out infinite}

        /* Brand */
        .brand{font-weight:700;color:var(--accent);font-size:1.25rem;letter-spacing:0.4px;animation:floatSlow 8s ease-in-out infinite}
        .brand + div{font-size:0.9rem;color:var(--muted);margin-top:2px}

        /* Controls */
        .controls{display:flex;gap:10px;align-items:center}
        .btn{background:rgba(255,255,255,0.03);border:1px solid rgba(126,231,199,calc(0.08 * var(--opacity)));color:inherit;padding:8px 12px;border-radius:10px;cursor:pointer;backdrop-filter:blur(10px);transition:all .2s;position:relative}
        .btn::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at center, rgba(126,231,199,0.1) 0%, transparent 70%);border-radius:10px;opacity:0;transition:opacity .2s}
        .btn:hover::before{opacity:1}
        .btn-primary{background:linear-gradient(90deg, rgba(126,231,199,calc(0.16 * var(--opacity))), rgba(125,211,252,calc(0.08 * var(--opacity))));border:1px solid rgba(126,231,199,calc(0.25 * var(--opacity)))}
        .btn:hover{transform:translateY(-2px);border-color:rgba(126,231,199,calc(0.18 * var(--opacity)));box-shadow:0 12px 28px rgba(126,231,199,calc(0.15 * var(--opacity))), inset 0 1px 0 rgba(255,255,255,0.1)}

        h1{margin:0 0 8px 0;font-weight:600;background:linear-gradient(90deg, #e9eef6, var(--accent), #7EE7C7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;background-size:200% 200%;animation:gradientShift 12s ease infinite}
        p.lead{margin:0;color:var(--muted);line-height:1.45}

        .banner{margin-top:16px;padding:14px;border-radius:12px;background:linear-gradient(90deg, rgba(126,231,199,calc(0.06 * var(--opacity))), rgba(99,102,241,calc(0.04 * var(--opacity))));border:1px solid rgba(126,231,199,calc(0.15 * var(--opacity)));color:var(--muted);backdrop-filter:blur(10px);animation:pulseGlow 8s ease-in-out infinite}

        .main{flex:1;display:flex;align-items:center;justify-content:center;padding:44px;position:relative;z-index:3}
        .footer{padding:20px;text-align:center;color:var(--muted);font-size:0.95rem;border-top:1px solid rgba(126,231,199,0.08);background:rgba(7,16,32,0.2)}

        /* Modal */
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(2,6,23,calc(0.65 * var(--opacity)));display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;pointer-events:none;backdrop-filter:blur(calc(6px * var(--opacity)));transition:all .3s cubic-bezier(0.4, 0, 0.2, 1)}
        .modal.active{opacity:1;pointer-events:auto}
        .modal-content{background:linear-gradient(135deg, rgba(255,255,255,calc(0.04 * var(--opacity))), rgba(126,231,199,calc(0.02 * var(--opacity))));border:1px solid rgba(126,231,199,calc(0.15 * var(--opacity)));border-radius:14px;padding:26px;max-width:720px;width:94%;max-height:86vh;overflow:auto;box-shadow:0 25px 50px -12px rgba(0,0,0,0.5),inset 0 1px 0 rgba(255,255,255,0.08);transform:translateY(6px) scale(0.95);opacity:0;backdrop-filter:blur(20px);transition:all .3s cubic-bezier(0.4, 0, 0.2, 1)}
        .modal.active .modal-content{transform:translateY(0) scale(1);opacity:1}

        .modal-content h2{margin:0 0 16px 0;color:var(--accent);font-weight:600}
        .modal-content input,.modal-content select{width:100%;padding:10px;margin:8px 0;background:rgba(255,255,255,calc(0.03 * var(--opacity)));border:1px solid rgba(126,231,199,calc(0.1 * var(--opacity)));border-radius:10px;color:inherit;font-size:1rem;backdrop-filter:blur(10px);transition:all .2s}
        .modal-content input:focus,.modal-content select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(126,231,199,calc(0.15 * var(--opacity))), inset 0 1px 0 rgba(255,255,255,0.05)}

        .modal-content button{width:100%;margin-top:12px;padding:10px;font-weight:600;border-radius:10px;transition:all .2s}
        .modal-content button:hover{transform:translateY(-1px)}
        .modal-toggle{display:flex;gap:8px;margin-top:12px}
        .modal-toggle button{flex:1}
        .modal-close{float:right;background:none;border:none;font-size:1.4rem;cursor:pointer;color:var(--accent);transition:all .2s;padding:4px}
        .modal-close:hover{transform:rotate(90deg) scale(1.1)}

        /* Settings */
        .settings-container{display:flex;gap:18px;flex-wrap:wrap}
        .settings-section{flex:1;min-width:260px;padding:16px;border-radius:12px;background:linear-gradient(135deg, rgba(255,255,255,calc(0.025 * var(--opacity))), rgba(126,231,199,calc(0.012 * var(--opacity))));border:1px solid rgba(126,231,199,calc(0.1 * var(--opacity)));backdrop-filter:blur(10px);transition:all .3s;animation:floatSlow 20s ease-in-out infinite}
        .settings-section:hover{border-color:rgba(126,231,199,calc(0.2 * var(--opacity)));box-shadow:0 8px 24px rgba(126,231,199,calc(0.08 * var(--opacity)))}
        .settings-section h3{margin:0 0 12px 0;color:var(--accent);font-size:0.95rem}
        .settings-row{margin:12px 0;display:flex;justify-content:space-between;align-items:center;gap:8px}
        .settings-row label{font-size:0.92rem;color:var(--muted)}

        .currency-list{max-height:220px;overflow-y:auto;border:1px solid rgba(126,231,199,calc(0.1 * var(--opacity)));border-radius:8px;padding:8px;background:linear-gradient(135deg, rgba(0,0,0,calc(0.15 * var(--opacity))), rgba(0,0,0,calc(0.08 * var(--opacity))))}
        .currency-item{padding:8px;margin:6px 0;background:rgba(126,231,199,calc(0.08 * var(--opacity)));border:1px solid rgba(126,231,199,calc(0.16 * var(--opacity)));border-radius:8px;display:flex;justify-content:space-between;align-items:center;transition:all .2s}
        .currency-item:hover{background:rgba(126,231,199,calc(0.12 * var(--opacity)));box-shadow:0 4px 12px rgba(126,231,199,calc(0.1 * var(--opacity)))}
        .currency-item button{padding:6px 10px;font-size:0.86rem;border-radius:8px}

        .nav-tabs{display:flex;gap:8px;margin-bottom:16px;border-bottom:1px solid rgba(126,231,199,calc(0.1 * var(--opacity)));padding-bottom:8px;overflow-x:auto}
        .nav-tabs button{background:none;border:none;padding:8px 12px;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;white-space:nowrap;transition:all .2s}
        .nav-tabs button:hover{color:var(--accent)}
        .nav-tabs button.active{border-bottom-color:var(--accent);color:var(--accent)}
        .tab-content{display:none;animation:fadeIn .3s ease}
        .tab-content.active{display:block}

        .error-msg{color:#ff8787;font-size:0.92rem;margin-top:8px}

        /* Opacity slider styling */
        input[type="range"]{width:100%;height:6px;border-radius:3px;background:linear-gradient(90deg, rgba(126,231,199,0.2), rgba(126,231,199,0.4));outline:none;-webkit-appearance:none}
        input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 2px 8px rgba(126,231,199,0.4);transition:all .2s}
        input[type="range"]::-webkit-slider-thumb:hover{transform:scale(1.2);box-shadow:0 4px 16px rgba(126,231,199,0.6)}
        input[type="range"]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:var(--accent);cursor:pointer;border:none;box-shadow:0 2px 8px rgba(126,231,199,0.4);transition:all .2s}
        input[type="range"]::-moz-range-thumb:hover{transform:scale(1.2);box-shadow:0 4px 16px rgba(126,231,199,0.6)}

        /* small screens */
        @media (max-width:920px){.main{padding:28px}.settings-container{flex-direction:column}.card{padding:20px}}
        @media (max-width:520px){.topbar{padding:10px 14px}.brand{font-size:1.05rem}}

        .dashboard-icons {
            display: flex;
            gap: 6px;
            align-items: center;
            position: relative;
            z-index: 600;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid rgba(126,231,199,0.2);
            background: rgba(126,231,199,0.08);
            color: var(--accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all .3s;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 601;
        }

        .icon-btn:hover {
            transform: scale(1.15);
            background: rgba(126,231,199,0.15);
            box-shadow: 0 0 20px rgba(126,231,199,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
            border-color: rgba(126,231,199,0.4);
        }

        .icon-btn.active::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid var(--accent);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(126,231,199,0.7); }
            50% { box-shadow: 0 0 0 6px rgba(126,231,199,0); }
        }

        /* Popup Styles */
        .settings-popup {
            position: fixed;
            background: linear-gradient(135deg, rgba(255,255,255,calc(0.04 * var(--opacity))), rgba(126,231,199,calc(0.02 * var(--opacity))));
            border: 1px solid rgba(126,231,199,calc(0.15 * var(--opacity)));
            border-radius: 14px;
            padding: 16px;
            max-width: 320px;
            max-height: 400px;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.08);
            z-index: 2000;
            animation: popupSlideIn .3s ease;
            display: none;
            top: 60px;
            right: 16px;
        }

        html[dir="rtl"] .settings-popup {
            right: auto;
            left: 16px;
        }

        .settings-popup.active {
            display: block;
        }

        @keyframes popupSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(126,231,199,0.1);
        }

        .popup-header h3 {
            margin: 0;
            font-size: 0.95rem;
            color: var(--accent);
            font-weight: 600;
        }

        .popup-close {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            font-size: 1.2rem;
            transition: transform .2s;
        }

        .popup-close:hover {
            transform: rotate(90deg) scale(1.1);
        }

        .popup-item {
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .popup-item label {
            font-size: 0.9rem;
            color: var(--muted);
            flex: 1;
        }

        .popup-item select,
        .popup-item input {
            flex: 1;
            padding: 6px 8px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(126,231,199,0.1);
            border-radius: 6px;
            color: inherit;
            font-size: 0.85rem;
        }

        .popup-item input[type="checkbox"],
        .popup-item input[type="radio"] {
            flex: none;
            width: 16px;
            height: 16px;
        }

        .popup-button {
            width: 100%;
            padding: 8px;
            margin-top: 8px;
            background: linear-gradient(90deg, rgba(126,231,199,0.15), rgba(125,211,252,0.08));
            border: 1px solid rgba(126,231,199,0.2);
            border-radius: 6px;
            color: inherit;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all .2s;
        }

        /* Fullscreen Budget Settings Panel */
        .fullscreen-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(7,16,32,0.95), rgba(20,40,80,0.95));
            backdrop-filter: blur(20px);
            z-index: 3000;
            display: none;
            flex-direction: column;
            overflow: hidden;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .fullscreen-panel.active {
            display: flex;
            pointer-events: auto;
            opacity: 1;
            visibility: visible;
            animation: panelSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .fullscreen-panel.closing {
            animation: panelSlideOut 0.3s ease-out forwards;
        }

        @keyframes panelSlideIn {
            from {
                opacity: 0;
                transform: translateY(-100%);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes panelSlideOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-100%);
            }
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 32px;
            background: rgba(7,16,32,0.8);
            border-bottom: 1px solid rgba(126,231,199,0.1);
            backdrop-filter: blur(15px);
            flex-shrink: 0;
            width: 100%;
            box-sizing: border-box;
        }

        .panel-header h2 {
            margin: 0;
            font-size: 2rem;
            color: var(--accent);
            font-weight: 700;
        }

        .panel-close {
            width: 44px;
            height: 44px;
            border: none;
            background: rgba(126,231,199,0.1);
            border-radius: 50%;
            color: var(--accent);
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all .3s;
        }

        .panel-close:hover {
            background: rgba(126,231,199,0.2);
            transform: scale(1.1);
        }

        .panel-content {
            padding: 32px;
            max-width: 1000px;
            margin: 0 auto;
            padding-bottom: 120px;
            flex: 1;
            overflow-y: auto;
            width: 100%;
        }

        /* Budget Steps & Workflow */
        .budget-step {
            background: linear-gradient(135deg, rgba(255,255,255,calc(0.05 * var(--opacity))), rgba(126,231,199,calc(0.02 * var(--opacity))));
            border: 1px solid rgba(126,231,199,calc(0.15 * var(--opacity)));
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
            transition: all .3s ease;
        }

        .budget-step:hover {
            background: linear-gradient(135deg, rgba(255,255,255,calc(0.08 * var(--opacity))), rgba(126,231,199,calc(0.04 * var(--opacity))));
            border-color: rgba(126,231,199,calc(0.25 * var(--opacity)));
            box-shadow: 0 12px 48px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .step-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(126,231,199,0.2);
            border: 2px solid rgba(126,231,199,0.5);
            color: var(--accent);
            font-weight: 700;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .step-title {
            margin: 0;
            color: var(--accent);
            font-size: 1.3rem;
            font-weight: 600;
        }

        .step-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Period Selector */
        .period-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .period-btn {
            padding: 14px 16px;
            border: 2px solid rgba(126,231,199,0.2);
            background: rgba(126,231,199,0.05);
            border-radius: 12px;
            color: var(--muted);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all .3s ease;
            white-space: nowrap;
        }

        .period-btn:hover {
            border-color: rgba(126,231,199,0.4);
            background: rgba(126,231,199,0.1);
        }

        .period-btn.active {
            border-color: var(--accent);
            background: rgba(126,231,199,0.25);
            color: var(--accent);
            box-shadow: 0 0 16px rgba(126,231,199,0.3);
        }

        .period-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            padding: 16px;
            background: rgba(126,231,199,0.05);
            border-radius: 12px;
            margin-top: 12px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            color: var(--muted);
            font-size: 0.85rem;
            margin-bottom: 6px;
            display: block;
        }

        .stat-value {
            color: var(--accent);
            font-weight: 700;
            font-size: 1.2rem;
            display: block;
        }

        /* Custom Date Range */
        .date-range-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .date-input-wrapper {
            display: flex;
            flex-direction: column;
        }

        .date-input-wrapper label {
            color: var(--muted);
            font-size: 0.85rem;
            margin-bottom: 6px;
            font-weight: 500;
        }

        /* Calculations Grid */
        .calculations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .calc-card {
            background: rgba(126,231,199,0.08);
            border: 1px solid rgba(126,231,199,0.15);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all .3s ease;
        }

        .calc-card:hover {
            background: rgba(126,231,199,0.12);
            border-color: rgba(126,231,199,0.3);
        }

        .calc-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
            display: block;
        }

        .calc-label {
            color: var(--muted);
            font-size: 0.8rem;
            margin-bottom: 8px;
            display: block;
        }

        .calc-value {
            color: var(--accent);
            font-weight: 700;
            font-size: 1.25rem;
            display: block;
        }

        /* Progress Bar Large */
        .progress-bar-large {
            width: 100%;
            height: 12px;
            background: rgba(126,231,199,0.1);
            border-radius: 6px;
            overflow: hidden;
            margin: 16px 0 8px 0;
            border: 1px solid rgba(126,231,199,0.15);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #7EE7C7, #5DD4B4);
            border-radius: 6px;
            transition: width .6s ease;
            width: 0%;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #FFA500, #FF8C00);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, #FF6B6B, #EE5A52);
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: var(--muted);
        }

        /* Info Box */
        .info-box {
            background: rgba(126,231,199,0.08);
            border-left: 4px solid rgba(126,231,199,0.5);
            border-radius: 8px;
            padding: 14px 16px;
            margin-top: 12px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .info-box.warning {
            background: rgba(255,165,0,0.08);
            border-left-color: rgba(255,165,0,0.5);
        }

        .info-box.danger {
            background: rgba(255,107,107,0.08);
            border-left-color: rgba(255,107,107,0.5);
        }

        .info-icon {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .info-text {
            font-size: 0.9rem;
            line-height: 1.4;
            color: var(--muted);
        }

        /* Collapsible Sections */
        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 14px;
            background: rgba(126,231,199,0.08);
            border-radius: 10px;
            transition: all .3s ease;
            user-select: none;
        }

        .collapsible-header:hover {
            background: rgba(126,231,199,0.12);
        }

        .collapsible-title {
            color: var(--accent);
            font-weight: 600;
            margin: 0;
        }

        .collapsible-icon {
            font-size: 1.2rem;
            transition: transform .3s ease;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height .3s ease;
            padding: 0;
        }

        .collapsible-content.active {
            max-height: 2000px;
            padding: 16px 0;
        }

        .collapsible-body {
            padding: 16px;
            background: rgba(126,231,199,0.04);
            border-radius: 10px;
            margin-top: 8px;
        }

        /* Input Groups */
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .input-group label {
            color: var(--muted);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            padding: 12px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(126,231,199,0.15);
            border-radius: 8px;
            color: inherit;
            font-size: 1rem;
            transition: all .2s;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            background: rgba(255,255,255,0.08);
            border-color: rgba(126,231,199,0.4);
            box-shadow: 0 0 12px rgba(126,231,199,0.2);
        }

        .input-with-icon {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-with-icon input {
            padding-right: 32px;
        }

        .input-icon {
            position: absolute;
            right: 12px;
            color: var(--muted);
            font-weight: 600;
        }

        /* Checkbox Groups */
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: rgba(126,231,199,0.04);
            border-radius: 10px;
            cursor: pointer;
            transition: all .2s;
        }

        .checkbox-item:hover {
            background: rgba(126,231,199,0.08);
        }

        .checkbox-item input[type="checkbox"] {
            margin-top: 4px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent);
            flex-shrink: 0;
        }

        .checkbox-label {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .checkbox-label strong {
            color: var(--accent);
            font-weight: 600;
        }

        .checkbox-description {
            color: var(--muted);
            font-size: 0.85rem;
            line-height: 1.3;
        }

        /* Action Buttons */
        .panel-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            padding: 16px 32px;
            background: rgba(7,16,32,0.95);
            border-top: 1px solid rgba(126,231,199,0.1);
            backdrop-filter: blur(15px);
            flex-shrink: 0;
            width: 100%;
            box-sizing: border-box;
        }

        .btn-secondary {
            padding: 14px;
            background: rgba(126,231,199,0.1);
            border: 1px solid rgba(126,231,199,0.2);
            border-radius: 10px;
            color: var(--muted);
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all .3s;
        }

        .btn-secondary:hover {
            background: rgba(126,231,199,0.15);
            border-color: rgba(126,231,199,0.3);
        }

        .btn-primary {
            padding: 14px;
            background: linear-gradient(90deg, rgba(126,231,199,0.3), rgba(125,211,252,0.2));
            border: 1px solid rgba(126,231,199,0.4);
            border-radius: 10px;
            color: var(--accent);
            cursor: pointer;
            font-weight: 700;
            font-size: 1rem;
            transition: all .3s;
        }

        .btn-primary:hover {
            background: linear-gradient(90deg, rgba(126,231,199,0.4), rgba(125,211,252,0.3));
            border-color: rgba(126,231,199,0.6);
            box-shadow: 0 0 20px rgba(126,231,199,0.3);
        }

        /* Dynamic Add Button */
        .add-btn {
            padding: 10px 16px;
            background: rgba(126,231,199,0.15);
            border: 1px solid rgba(126,231,199,0.3);
            border-radius: 8px;
            color: var(--accent);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all .2s;
            width: 100%;
            text-align: center;
        }

        .add-btn:hover {
            background: rgba(126,231,199,0.25);
            border-color: rgba(126,231,199,0.5);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .panel-content {
                padding: 24px;
            }

            .budget-step {
                padding: 20px;
            }

            .calculations-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .period-selector {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .panel-header {
                padding: 16px 20px;
            }

            .panel-header h2 {
                font-size: 1.5rem;
            }

            .panel-content {
                padding: 16px;
                padding-bottom: 100px;
            }

            .budget-step {
                padding: 16px;
                margin-bottom: 16px;
            }

            .step-header {
                gap: 12px;
            }

            .step-number {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }

            .step-title {
                font-size: 1.1rem;
            }

            .calculations-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .calc-card {
                padding: 12px;
            }

            .period-selector {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .period-btn {
                padding: 12px 14px;
                font-size: 0.9rem;
            }

            .date-range-group {
                grid-template-columns: 1fr;
            }

            .panel-actions {
                grid-template-columns: 1fr;
                padding: 12px 16px;
                gap: 12px;
            }

            .btn-secondary,
            .btn-primary {
                padding: 12px;
                font-size: 0.95rem;
            }
        }

        @media (max-width: 480px) {
            .panel-header {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }

            .panel-header h2 {
                font-size: 1.3rem;
            }

            .panel-content {
                padding: 12px;
            }

            .budget-step {
                padding: 12px;
            }

            .step-header {
                flex-direction: column;
                text-align: center;
                gap: 8px;
            }

            .step-number {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }

            .calculations-grid {
                grid-template-columns: 1fr;
            }

            .period-selector {
                grid-template-columns: 1fr;
            }

            .period-stats {
                grid-template-columns: 1fr;
            }
        }

        /* Add Transaction Modal */
        .add-transaction-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background: linear-gradient(135deg, rgba(255,255,255,calc(0.08 * var(--opacity))), rgba(126,231,199,calc(0.03 * var(--opacity))));
            border: 1px solid rgba(126,231,199,calc(0.2 * var(--opacity)));
            border-radius: 20px;
            padding: 28px;
            max-width: 400px;
            width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            box-shadow: 0 25px 60px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
            z-index: 3500;
            display: none;
            animation: modalSlideIn .3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .add-transaction-modal.active {
            display: block;
            animation: modalSlideIn .3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .modal-title {
            margin: 0 0 20px 0;
            color: var(--accent);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: var(--muted);
            font-size: 1.8rem;
            cursor: pointer;
            transition: all .2s;
        }

        .modal-close-btn:hover {
            color: var(--accent);
            transform: scale(1.2);
        }

        .form-group {
            margin: 16px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--muted);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(126,231,199,0.15);
            border-radius: 8px;
            color: inherit;
            font-size: 1rem;
            transition: all .2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            background: rgba(255,255,255,0.08);
            border-color: rgba(126,231,199,0.4);
            box-shadow: 0 0 12px rgba(126,231,199,0.15);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .transaction-type-toggle {
            display: flex;
            gap: 12px;
            margin: 16px 0;
        }

        .type-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid rgba(126,231,199,0.2);
            background: rgba(126,231,199,0.05);
            border-radius: 8px;
            color: var(--muted);
            cursor: pointer;
            font-weight: 600;
            transition: all .3s;
        }

        .type-btn.active {
            border-color: var(--accent);
            background: rgba(126,231,199,0.2);
            color: var(--accent);
            box-shadow: 0 0 16px rgba(126,231,199,0.3);
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-cancel {
            padding: 12px;
            background: rgba(126,231,199,0.1);
            border: 1px solid rgba(126,231,199,0.2);
            border-radius: 8px;
            color: var(--muted);
            cursor: pointer;
            font-weight: 600;
            transition: all .2s;
        }

        .btn-cancel:hover {
            background: rgba(126,231,199,0.15);
            border-color: rgba(126,231,199,0.3);
        }

        .btn-save {
            padding: 12px;
            background: linear-gradient(90deg, rgba(126,231,199,0.3), rgba(125,211,252,0.2));
            border: 1px solid rgba(126,231,199,0.4);
            border-radius: 8px;
            color: var(--accent);
            cursor: pointer;
            font-weight: 700;
            transition: all .2s;
        }

        .btn-save:hover {
            background: linear-gradient(90deg, rgba(126,231,199,0.4), rgba(125,211,252,0.3));
            border-color: rgba(126,231,199,0.6);
            box-shadow: 0 0 20px rgba(126,231,199,0.3);
        }

        @media (max-width: 768px) {
            .panel-header {
                padding: 16px 20px;
            }

            .panel-header h2 {
                font-size: 1.5rem;
            }

            .panel-content {
                padding: 16px;
            }

            .budget-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .add-transaction-modal {
                max-width: 95vw;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div style="display:flex;align-items:center;gap:12px">
                <div class="glass" style="display:flex;align-items:center;gap:12px;padding:8px 12px">
                    <div class="brand">×ª×§×¦×™×‘ ×–×›×•×›×™×ª</div>
                    <div style="font-size:0.9rem;color:#bfcbd8">v1.01</div>
                </div>
                <div class="glass" style="padding:6px 10px"> 
                    <label for="loginDrop">×›× ×™×¡×”</label>
                    <button id="authBtn" style="width:auto">×”×¨×©××” / ×›× ×™×¡×”</button>
                </div>
            </div>

            <!-- Tip container (top-right) -->
            <div id="tipContainer" style="position:fixed;top:18px;right:18px;z-index:1200;min-width:260px;max-width:360px;display:none">
                <div id="tipBox" class="glass" style="padding:12px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.45);">
                    <div id="tipText" style="font-size:0.98rem;color:#e8f6ee;line-height:1.3"></div>
                </div>
            </div>

            <!-- Floating Dashboard Icons -->
            <div class="dashboard-icons">
                <button class="icon-btn" id="icon-budget" title="×ª×§×¦×™×‘" onclick="openBudgetPanel()">ğŸ’°</button>
                <button class="icon-btn" id="icon-design" title="×¢×™×¦×•×‘" onclick="openPopup('design-popup')">ğŸ¨</button>
                <button class="icon-btn" id="icon-language" title="×—×©×‘×•×Ÿ:" onclick="openPopup('language-popup')">ğŸŒ</button>
                <button class="icon-btn" id="icon-notifications" title="×”×ª×¨××•×ª" onclick="openPopup('notifications-popup')">ğŸ””</button>
                <button class="icon-btn" id="icon-tips" title="×˜×™×¤×™×" onclick="openPopup('tips-popup')">ğŸ’¡</button>
                <button class="icon-btn" id="icon-account" title="×—×©×‘×•×Ÿ" onclick="openPopup('account-popup')">ğŸ‘¤</button>
            </div>
        </header>

        <main class="main">
            <div class="card glass">
                <h1>×”×›×¡×£ ×©×œ×™</h1>
                <p class="lead">×’×¨×¡×” 1.01 

                </p>

            

                <section style="margin-top:18px;display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
                    <div class="glass" style="padding:16px">
                        <strong>××˜×‘×¢</strong>
                        <p id="currencyInfo">×¢×“×™×™×Ÿ ×œ× ×”×•×’×“×¨×• ××˜×‘×¢×•×ª</p>
                    </div>
                    <div class="glass" style="padding:16px">
                        <strong>×ª×§×¦×™×‘</strong>
                        <p id="budgetInfo">××™×Ÿ × ×ª×•× ×™× ×¢×“×™×™×Ÿ</p>
                    </div>
                    <div class="glass" style="padding:16px">
                        <strong>×™×¢×“×™ ×—×™×¡×›×•×Ÿ</strong>
                        <p id="goalsInfo">××™×Ÿ ×™×¢×“×™× ×¢×“×™×™×Ÿ</p>
                    </div>
                </section>

                <!-- Quick transactions (for testing budget system) -->
                <section style="margin-top:18px;display:flex;flex-direction:column;gap:8px">
                    <div class="glass" style="padding:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                        <select id="txType" style="padding:8px;border-radius:8px">
                            <option value="expense">×”×•×¦××”</option>
                            <option value="income">×”×›× ×¡×”</option>
                        </select>
                        <input type="number" id="txAmount" placeholder="×¡×›×•×" style="padding:8px;border-radius:8px;width:120px" />
                        <select id="txCurrency" style="padding:8px;border-radius:8px">
                            <option value="USD">USD</option>
                            <option value="ILS">ILS</option>
                            <option value="EUR">EUR</option>
                        </select>
                        <input type="date" id="txDate" style="padding:8px;border-radius:8px" />
                        <input type="text" id="txCategory" placeholder="×§×˜×’×•×¨×™×” (××•×¤×¦×™×•× ×œ×™)" style="padding:8px;border-radius:8px;width:160px" />
                        <input type="text" id="txDesc" placeholder="×ª××•×¨ (××•×¤×¦×™×•× ×œ×™)" style="padding:8px;border-radius:8px;flex:1" />
                        <button id="txAddBtn" type="button" class="btn btn-primary">×”×•×¡×£</button>
                    </div>

                    <div id="txList" class="glass" style="padding:12px;max-height:200px;overflow:auto;border-radius:12px"></div>
                </section>
            </div>
        </main>

        <footer class="footer">×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª Â©2025 ×§×¨×“×™×˜ ×œ×¡×œ×™×</footer>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeAuthModal()">Ã—</button>
            <h2 id="authTitle">×”×¨×©××” / ×›× ×™×¡×”</h2>
            
            <div id="loginForm" style="display:block">
                <input type="email" id="loginEmail" placeholder="×“×•××¨ ××œ×§×˜×¨×•× ×™" />
                <input type="password" id="loginPassword" placeholder="×¡×™×¡××”" />
                <button id="loginBtn" onclick="handleLogin()">×›× ×™×¡×”</button>
                <div id="loginError" class="error-msg"></div>
            </div>

            <div id="signupForm" style="display:none">
                <input type="email" id="signupEmail" placeholder="×“×•××¨ ××œ×§×˜×¨×•× ×™" />
                <input type="text" id="signupUsername" placeholder="×©× ××©×ª××©" />
                <input type="password" id="signupPassword" placeholder="×¡×™×¡××”" />
                <input type="password" id="signupConfirm" placeholder="××™×©×•×¨ ×¡×™×¡××”" />
                <button id="signupBtn" onclick="handleSignup()">×”×¨×©××”</button>
                <div id="signupError" class="error-msg"></div>
            </div>

            <div class="modal-toggle">
                <button onclick="switchToLogin()">×›× ×™×¡×”</button>
                <button onclick="switchToSignup()">×”×¨×©××”</button>
                <button onclick="handleGuestMode()">××•×¨×—</button>
            </div>

            <button onclick="handleGoogleLogin()" style="width:100%;margin-top:16px;padding:10px;border:1px solid rgba(255,255,255,0.2)">×›× ×™×¡×” ×¢× Google</button>
        </div>
    </div>

    <!-- Settings Modal (Redesigned - Clean & Simple) -->
    <!-- FULLSCREEN BUDGET SETTINGS PANEL -->
    <div id="budget-fullscreen" class="fullscreen-panel">
        <div class="panel-header">
            <div>
                <h2>ğŸ’° ×”×’×“×¨×•×ª ×ª×§×¦×™×‘ ×—×›×</h2>
                <p style="margin: 4px 0 0 0; color: var(--muted); font-size: 0.9rem;">×‘× ×” ××ª ×ª×§×¦×™×‘×š ×¦×¢×“ ××—×¨ ×¦×¢×“</p>
            </div>
            <button class="panel-close" onclick="closeBudgetPanel()">Ã—</button>
        </div>

        <div class="panel-content">
            <!-- STEP 1: SET TOTAL BUDGET -->
            <div class="budget-step">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <h3 class="step-title">×”×’×“×¨ ×¡×›×•× ×ª×§×¦×™×‘ ×›×•×œ×œ</h3>
                </div>

                <div class="step-content">
                    <div class="input-group">
                        <label>×¡×›×•× ×”×ª×§×¦×™×‘</label>
                        <div class="input-with-icon">
                            <input type="number" id="totalBudgetInput" placeholder="5000" min="0" step="100" onchange="updateAllCalculations()" />
                            <span class="input-icon">â‚ª</span>
                        </div>
                        <small style="color: var(--muted);">×“×•×’××”: ×ª×§×¦×™×‘ ×—×•×“×©×™ ×©×œ×š</small>
                    </div>

                    <div class="info-box">
                        <span class="info-icon">ğŸ’¡</span>
                        <span class="info-text">×”×’×“×¨×ª ×ª×§×¦×™×‘ ×›×•×œ×œ ×”×™× ×”×‘×¡×™×¡ ×œ×›×œ ×”×ª×›× ×™×•×ª ×©×œ×š</span>
                    </div>
                </div>
            </div>

            <!-- STEP 2: SET TIME RANGE -->
            <div class="budget-step">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <h3 class="step-title">×‘×—×¨ ×˜×•×•×— ×–××Ÿ</h3>
                </div>

                <div class="step-content">
                    <div class="period-selector">
                        <button class="period-btn active" data-period="daily" onclick="setPeriod('daily')">ğŸ“… ×™×•××™</button>
                        <button class="period-btn" data-period="weekly" onclick="setPeriod('weekly')">ğŸ“† ×©×‘×•×¢×™</button>
                        <button class="period-btn" data-period="monthly" onclick="setPeriod('monthly')">ğŸ“Š ×—×•×“×©×™</button>
                        <button class="period-btn" data-period="custom" onclick="setPeriod('custom')">ğŸ“ ××•×ª××</button>
                    </div>

                    <!-- Custom Date Range (Hidden by default) -->
                    <div id="customDateRange" style="display: none; margin-top: 16px;">
                        <div class="date-range-group">
                            <div class="date-input-wrapper">
                                <label>×ª××¨×™×š ×”×ª×—×œ×”</label>
                                <input type="date" id="customStartDate" onchange="updateAllCalculations()" />
                            </div>
                            <div class="date-input-wrapper">
                                <label>×ª××¨×™×š ×¡×™×•×</label>
                                <input type="date" id="customEndDate" onchange="updateAllCalculations()" />
                            </div>
                        </div>
                    </div>

                    <!-- Period Info Display -->
                    <div class="period-stats">
                        <div class="stat-item">
                            <span class="stat-label">×™××™× ×‘×ª×§×•×¤×”</span>
                            <span class="stat-value" id="totalDaysInPeriod">30</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">×™××™× ×©× ×•×ª×¨×•</span>
                            <span class="stat-value" id="remainingDaysInPeriod">30</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">××—×•×– ×‘×ª×§×•×¤×”</span>
                            <span class="stat-value" id="periodProgress">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STEP 3: AUTOMATIC CALCULATIONS -->
            <div class="budget-step">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <h3 class="step-title">×—×™×©×•×‘×™× ××•×˜×•××˜×™×™×</h3>
                </div>

                <div class="step-content">
                    <div class="calculations-grid">
                        <div class="calc-card">
                            <div class="calc-icon">ğŸ’µ</div>
                            <span class="calc-label">×”×§×¦××” ×™×•××™×ª</span>
                            <span class="calc-value" id="calcDaily">0 â‚ª</span>
                        </div>

                        <div class="calc-card">
                            <div class="calc-icon">ğŸ“Š</div>
                            <span class="calc-label">×”×§×¦××” ×©×‘×•×¢×™×ª</span>
                            <span class="calc-value" id="calcWeekly">0 â‚ª</span>
                        </div>

                        <div class="calc-card">
                            <div class="calc-icon">ğŸ’³</div>
                            <span class="calc-label">×”×•×¦××•×ª ×¢×“ ×›×”</span>
                            <span class="calc-value" id="calcSpent">0 â‚ª</span>
                        </div>

                        <div class="calc-card">
                            <div class="calc-icon">ğŸ¯</div>
                            <span class="calc-label">×™×ª×¨×” ×–××™× ×”</span>
                            <span class="calc-value" id="calcBalance">0 â‚ª</span>
                        </div>
                    </div>

                    <!-- Spending Progress -->
                    <div style="margin-top: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--muted); font-weight: 500;">×§×¦×‘ ×”×•×¦××•×ª</label>
                        <div id="budgetProgressBar" class="progress-bar-large">
                            <div class="progress-fill"></div>
                        </div>
                        <div class="progress-info">
                            <span>0% ×”×•×¦××”</span>
                            <span>100% ×–××™×Ÿ</span>
                        </div>
                    </div>

                    <!-- Prediction Alert -->
                    <div class="info-box" id="predictionBox">
                        <span class="info-icon">â„¹ï¸</span>
                        <span class="info-text">×”×’×“×¨ ×ª×§×¦×™×‘ ×›×“×™ ×œ×§×‘×œ ×—×™×–×•×™</span>
                    </div>
                </div>
            </div>

            <!-- STEP 4: SAVINGS GOALS (OPTIONAL) -->
            <div class="budget-step">
                <div class="collapsible-header" onclick="toggleCollapsible(this.parentElement)">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                        <div class="step-number">4</div>
                        <h3 class="collapsible-title">×™×¢×“×™ ×—×™×¡×›×•×Ÿ (××•×¤×¦×™×•× ×œ×™)</h3>
                    </div>
                    <span class="collapsible-icon">â–¼</span>
                </div>

                <div class="collapsible-content">
                    <div class="collapsible-body">
                        <div style="display: grid; gap: 12px;">
                            <div class="input-group">
                                <label>×©× ×”×™×¢×“</label>
                                <input type="text" id="savingsGoalName" placeholder="×œ××©×œ: ×—×•×¤×©×” ×‘×§×™×¥" onchange="updateAllCalculations()" />
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div class="input-group">
                                    <label>×¡×›×•× ×™×¢×“</label>
                                    <input type="number" id="savingsGoalAmount" placeholder="0" min="0" onchange="updateAllCalculations()" />
                                </div>

                                <div class="input-group">
                                    <label>×ª××¨×™×š ×™×¢×“</label>
                                    <input type="date" id="savingsGoalDeadline" onchange="updateAllCalculations()" />
                                </div>
                            </div>

                            <div class="input-group">
                                <label>×”×¢×¨×•×ª</label>
                                <textarea id="savingsGoalNote" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™×..." style="min-height: 80px;"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STEP 5: CATEGORY LIMITS (OPTIONAL) -->
            <div class="budget-step">
                <div class="collapsible-header" onclick="toggleCollapsible(this.parentElement)">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                        <div class="step-number">5</div>
                        <h3 class="collapsible-title">××’×‘×œ×•×ª ×”×•×¦××•×ª ×œ×¤×™ ×§×˜×’×•×¨×™×” (××•×¤×¦×™×•× ×œ×™)</h3>
                    </div>
                    <span class="collapsible-icon">â–¼</span>
                </div>

                <div class="collapsible-content">
                    <div class="collapsible-body">
                        <div style="display: grid; gap: 12px;">
                            <small style="color: var(--muted);">×”×’×“×¨ ××’×‘×œ×” ×œ×›×œ ×§×˜×’×•×¨×™×” ×œ×œ× ×”×©×¤×¢×” ×¢×œ ×”×ª×§×¦×™×‘ ×”×›×•×œ×œ</small>

                            <div id="categoryLimitsContainer"></div>

                            <button class="add-btn" onclick="addCategoryLimitRow()">+ ×”×•×¡×£ ×§×˜×’×•×¨×™×”</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SMART FEATURES -->
            <div class="budget-step">
                <div class="step-header">
                    <div class="step-number">âš™ï¸</div>
                    <h3 class="step-title">×ª×›×•× ×•×ª ×—×›××•×ª</h3>
                </div>

                <div class="step-content">
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="autoAdjust" checked />
                            <div class="checkbox-label">
                                <strong>×”×ª×××” ××•×˜×•××˜×™×ª ×™×•××™×ª</strong>
                                <span class="checkbox-description">×—×™×©×•×‘ ××—×“×© ×©×œ ×ª×›×¡×™×¡ ×™×•××™ ×‘×”×ª×× ×œ×§×¦×‘ ×”×•×¦××•×ª</span>
                            </div>
                        </label>

                        <label class="checkbox-item">
                            <input type="checkbox" id="enableAlerts" checked />
                            <div class="checkbox-label">
                                <strong>×”×ª×¨××•×ª × ×™×”×•×œ</strong>
                                <span class="checkbox-description">×”×ª×¨××” ×›×©××ª×§×¨×‘×™× ×œ×œ×™××™×˜ ×”×ª×§×¦×™×‘ ××• ×§×˜×’×•×¨×™×”</span>
                            </div>
                        </label>

                        <label class="checkbox-item">
                            <input type="checkbox" id="enableGraphs" checked />
                            <div class="checkbox-label">
                                <strong>×”×¦×’ ×’×¨×¤×™×</strong>
                                <span class="checkbox-description">×ª×¦×•×’×” ×•×™×–×•××œ×™×ª ×©×œ × ×ª×•× ×™× ×•×˜×¨× ×“×™×</span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sticky Action Buttons -->
        <div class="panel-actions">
            <button class="btn-secondary" onclick="closeBudgetPanel()">×¡×’×•×¨</button>
            <button class="btn-primary" onclick="finalizeBudgetSettings()">ğŸ’¾ ×©××•×¨ ×”×’×“×¨×•×ª</button>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div id="add-transaction-modal" class="add-transaction-modal">
        <button class="modal-close-btn" onclick="closeAddTransactionModal()">Ã—</button>
        <h2 class="modal-title">×”×•×¡×£ ×¢×¡×§×”</h2>
        
        <div class="transaction-type-toggle">
            <button class="type-btn active" id="typeExpense" onclick="setTransactionType('expense')">ğŸ’¸ ×”×•×¦××”</button>
            <button class="type-btn" id="typeIncome" onclick="setTransactionType('income')">ğŸ’° ×”×›× ×¡×”</button>
        </div>

        <div class="form-group">
            <label>×ª×™××•×¨ / ×›×•×ª×¨×ª</label>
            <input type="text" id="txTitle" placeholder="×œ××” ×”× ×¢×‘×•×¨×™×?" />
        </div>

        <div class="form-group">
            <label>×§×˜×’×•×¨×™×”</label>
            <select id="txCategory">
                <option value="food">ğŸ• ××•×›×œ</option>
                <option value="transport">ğŸš• ×ª×—×‘×•×¨×”</option>
                <option value="entertainment">ğŸ® ×‘×™×“×•×¨</option>
                <option value="utilities">ğŸ’¡ ×©×™×¨×•×ª×™×</option>
                <option value="health">âš•ï¸ ×‘×¨×™××•×ª</option>
                <option value="work">ğŸ’¼ ×¢×‘×•×“×”</option>
                <option value="other">ğŸ“Œ ××—×¨</option>
            </select>
        </div>

        <div class="form-group">
            <label>×¡×›×•×</label>
            <input type="number" id="txAmount" placeholder="0.00" step="0.01" />
        </div>

        <div class="form-group">
            <label>×ª××¨×™×š</label>
            <input type="date" id="txDate" />
        </div>

        <div class="form-group">
            <label>×”×¢×¨×” (××•×¤×¦×™×•× ×œ×™)</label>
            <textarea id="txNote" placeholder="×”×•×¡×£ ×”×¢×¨×”..."></textarea>
        </div>

        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeAddTransactionModal()">×‘×™×˜×•×œ</button>
            <button class="btn-save" onclick="saveTransaction()">×©××•×¨</button>
        </div>
    </div>

    <!-- Add Transaction Button (Floating) -->
    <button id="addTransactionBtn" class="icon-btn" style="position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; font-size: 1.5rem; z-index: 500; box-shadow: 0 8px 24px rgba(126,231,199,0.3);" onclick="openAddTransactionModal()" title="×”×•×¡×£ ×¢×¡×§×”">â•</button>

    <!-- Design Popup -->
    <div id="design-popup" class="settings-popup">
        <div class="popup-header">
            <h3>ğŸ¨ ×¢×™×¦×•×‘</h3>
            <button class="popup-close" onclick="closePopup('design-popup')">Ã—</button>
        </div>
        <div class="popup-item">
            <label>×¢×¨×›×ª ×¦×‘×¢×™×</label>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0">
            <label style="flex:1;min-width:80px"><input type="radio" name="theme" value="dark" checked onchange="changeTheme('dark')"> ğŸŒ™ ××¤×œ</label>
            <label style="flex:1;min-width:80px"><input type="radio" name="theme" value="light" onchange="changeTheme('light')"> â˜€ï¸ ×‘×”×™×¨</label>
            <label style="flex:1;min-width:80px"><input type="radio" name="theme" value="transparent" onchange="changeTheme('transparent')"> ğŸ’ ×©×§×•×£</label>
        </div>
        <div class="popup-item" style="margin-top:12px">
            <label>×©×§×™×¤×•×ª ×–×›×•×›×™×ª</label>
            <input type="range" id="glassOpacity" min="0.2" max="1" step="0.05" value="1" onchange="updateGlassOpacity()" />
        </div>
        <div style="font-size:0.8rem;color:var(--muted);margin-top:8px">
            ××—×•×–: <span id="opacityValue">100%</span>
        </div>
    </div>

    <!-- Language Popup -->
    <div id="language-popup" class="settings-popup">
        <div class="popup-header">
            <h3>ğŸŒ ×©×¤×”</h3>
            <button class="popup-close" onclick="closePopup('language-popup')">Ã—</button>
        </div>
        <div class="popup-item">
            <select id="settingsLang" onchange="changeLanguageSetting()">
                <option value="he">×¢×‘×¨×™×ª</option>
                <option value="en">English</option>
                <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
            </select>
        </div>
    </div>

    <!-- Notifications Popup -->
    <div id="notifications-popup" class="settings-popup">
        <div class="popup-header">
            <h3>ğŸ”” ×”×ª×¨××•×ª</h3>
            <button class="popup-close" onclick="closePopup('notifications-popup')">Ã—</button>
        </div>
        <div class="popup-item">
            <input type="checkbox" id="enableNotif" checked onchange="toggleNotifications()" />
            <label>×”×¤×¢×œ ×”×ª×¨××•×ª</label>
        </div>
        <div class="popup-item">
            <label>××˜×‘×¢ ×¨××©×™</label>
            <select id="primaryCurrency" onchange="setPrimaryCurrency()">
                <option value="USD">USD - ×“×•×œ×¨</option>
                <option value="EUR">EUR - ×™×•×¨×•</option>
                <option value="GBP">GBP - ×¤××•× ×“</option>
                <option value="ILS">ILS - ×©×§×œ</option>
                <option value="JPY">JPY - ×™×™×Ÿ</option>
            </select>
        </div>
    </div>

    <!-- Tips Popup -->
    <div id="tips-popup" class="settings-popup">
        <div class="popup-header">
            <h3>ğŸ’¡ ×˜×™×¤×™×</h3>
            <button class="popup-close" onclick="closePopup('tips-popup')">Ã—</button>
        </div>
        <div class="popup-item">
            <input type="checkbox" id="enableTips2" checked onchange="toggleTipsGeneral()" />
            <label>×”×¨××” ×˜×™×¤×™×</label>
        </div>
        <div class="popup-item">
            <label>××©×š ×”×¦×’×”</label>
            <input type="range" id="tipsDuration2" min="5" max="60" value="25" onchange="updateTipsDuration2()" />
        </div>
        <div style="font-size:0.8rem;color:var(--muted);margin-top:8px">
            <span id="durationValue2">25</span> ×©× ×™×•×ª
        </div>
    </div>

    <!-- Account Popup -->
    <div id="account-popup" class="settings-popup">
        <div class="popup-header">
            <h3>ğŸ‘¤ ×—×©×‘×•×Ÿ</h3>
            <button class="popup-close" onclick="closePopup('account-popup')">Ã—</button>
        </div>
        <div class="popup-item">
            <label>××¦×‘ ×”×ª×—×‘×¨×•×ª</label>
        </div>
        <div style="font-size:0.85rem;color:var(--muted);margin:8px 0;padding:8px;background:rgba(126,231,199,0.05);border-radius:6px;border:1px solid rgba(126,231,199,0.1)">
            <span id="accountStatus">××•×¨×—</span>
        </div>
        <button class="popup-button" onclick="logOutUser()">×”×ª× ×ª×§×•×ª</button>
    </div>

    <script>
        const translations = {
            he: {
                brand: '×ª×§×¦×™×‘ ×–×›×•×›×™×ª',
                prototype: 'v1.01',
                login: '×›× ×™×¡×”',
                signInUp: '×”×¨×©××” / ×›× ×™×¡×”',
                continueGuest: '×”××©×š ×›××•×¨×—',
                googleLogin: '×›× ×™×¡×” ×¢× Google',
                language: '×©×¤×”:',
                tipsOn: '×˜×™×¤×™×: ×¤×¢×™×œ',
                tipsOff: '×˜×™×¤×™×: ×›×‘×•×™',
                notifications: '×”×•×“×¢×•×ª',
                welcome: '×‘×¨×•×›×™× ×”×‘××™× ×œÖ¾×ª×§×¦×™×‘ ×–×›×•×›×™×ª',
                intro: '××‘ ×˜×™×¤×•×¡ ××œ×’× ×˜×™ ×©×œ ×× ×”×œ ×ª×§×¦×™×‘ ×¢× ×¡×’× ×•×Ÿ ×–×›×•×›×™×ª. ×“×£ ×–×” ××•×’×© ×¢×œ ×™×“×™ ×©×¨×ª Python ××§×•××™.',
                loading: '×˜×•×¢×Ÿ ×”×’×“×¨×•×ªâ€¦',
                currency: '××˜×‘×¢',
                noCurrencies: '×¢×“×™×™×Ÿ ×œ× ×”×•×’×“×¨×• ××˜×‘×¢×•×ª',
                budget: '×ª×§×¦×™×‘',
                noData: '××™×Ÿ × ×ª×•× ×™× ×¢×“×™×™×Ÿ',
                savingsGoals: '×™×¢×“×™ ×—×™×¡×›×•×Ÿ',
                noGoals: '××™×Ÿ ×™×¢×“×™× ×¢×“×™×™×Ÿ',
                footer: '×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª Â© 2025',
                configNotSet: '××¤×ª×—×•×ª Supabase ×œ× ×”×•×’×“×¨×•. ×”×•×¡×™×¤×• ××¤×ª×—×•×ª ×œ×§×•×‘×¥ <code>.env</code> ×”××§×•××™. ×¨××• README ×œ×•×”×•×¨××•×ª.',
                configDetected: '×”×’×“×¨×•×ª Supabase ×–×•×”×•. ××•×›×Ÿ ×œ×”×©×ª×œ×‘×•×ª (××¤×ª×—×•×ª ××•×¡×ª×¨×™×).',
                configError: '×›×™×©×œ×•×Ÿ ×‘×˜×¢×™× ×ª × ×§×•×“×ª ×”Ö¾config: ',
                loginSuccess: '×›× ×¡×ª ×‘×”×¦×œ×—×”!',
                signupSuccess: '× ×¨×©××ª ×‘×”×¦×œ×—×”!',
                guestMode: '××¦×‘ ××•×¨×— ××•×¤×¢×œ',
                passwordMismatch: '×”×¡×™×¡×××•×ª ×œ× ×ª×•×××•×ª',
                requiredFields: '×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª',
                loginError: '×›×™×©×œ×•×Ÿ ×‘×›× ×™×¡×”',
                signupError: '×›×™×©×œ×•×Ÿ ×‘×”×¨×©××”',
                logout: '×”×ª× ×ª×§×•×ª',
                signupLoginBtnText: '×”×¨×©××” / ×›× ×™×¡×”',
                settings: '×”×’×“×¨×•×ª',
                appearance: '×ª×¦×•×’×”',
                currency_label: '××˜×‘×¢',
                notifications_label: '×”×•×“×¢×•×ª',
                tips_label: '×˜×™×¤×™×'
            },
            en: {
                brand: 'GlassBudget',
                prototype: 'v1.01',
                login: 'Login',
                signInUp: 'Sign in / Sign up',
                continueGuest: 'Continue as guest',
                googleLogin: 'Google (Supabase)',
                language: 'Language:',
                tipsOn: 'Tips: On',
                tipsOff: 'Tips: Off',
                notifications: 'Notifications',
                welcome: 'Welcome to GlassBudget',
                intro: 'A clean glass-morphism budgeting prototype. This page is a frontend skeleton served by a local Python server.',
                loading: 'Loading configurationâ€¦',
                currency: 'Currency',
                noCurrencies: 'No currencies configured yet',
                budget: 'Budget',
                noData: 'No data yet',
                savingsGoals: 'Savings Goals',
                noGoals: 'No goals yet',
                footer: 'All rights reserved Â© 2025',
                configNotSet: 'Supabase keys are not configured. Add keys to the local <code>.env</code>. See README for instructions.',
                configDetected: 'Supabase configuration detected. Ready to integrate (keys not shown).',
                configError: 'Failed to load config endpoint: ',
                loginSuccess: 'Logged in successfully!',
                signupSuccess: 'Signed up successfully!',
                guestMode: 'Guest mode enabled',
                passwordMismatch: 'Passwords do not match',
                requiredFields: 'Please fill in all fields',
                loginError: 'Login failed',
                signupError: 'Sign up failed',
                logout: 'Logout',
                signupLoginBtnText: 'Sign in / Sign up',
                settings: 'Settings',
                appearance: 'Appearance',
                currency_label: 'Currency',
                notifications_label: 'Notifications',
                tips_label: 'Tips'
            },
            ar: {
                brand: 'Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø²Ø¬Ø§Ø¬',
                prototype: 'v1.01',
                login: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
                signInUp: 'ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„',
                continueGuest: 'Ù…ØªØ§Ø¨Ø¹Ø© ÙƒØ¶ÙŠÙ',
                googleLogin: 'Google (Supabase)',
                language: 'Ø§Ù„Ù„ØºØ©:',
                tipsOn: 'Ù†ØµØ§Ø¦Ø­: Ù…ÙØ¹Ù„',
                tipsOff: 'Ù†ØµØ§Ø¦Ø­: Ù…Ø¹Ø·Ù„',
                notifications: 'Ø¥Ø®Ø·Ø§Ø±Ø§Øª',
                welcome: 'Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ ÙÙŠ Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø²Ø¬Ø§Ø¬',
                intro: 'Ù†Ù…ÙˆØ°Ø¬ Ø£ÙˆÙ„ÙŠ Ø£Ù†ÙŠÙ‚ Ù„Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø¨Ù†Ù…Ø· Ø²Ø¬Ø§Ø¬ÙŠ. ÙŠØªÙ… ØªÙˆÙÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ø¨ÙˆØ§Ø³Ø·Ø© Ø®Ø§Ø¯Ù… Python Ù…Ø­Ù„ÙŠ.',
                loading: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙƒÙˆÙŠÙ†...',
                currency: 'Ø§Ù„Ø¹Ù…Ù„Ø©',
                noCurrencies: 'Ù„Ù… ÙŠØªÙ… ØªÙƒÙˆÙŠÙ† Ø¹Ù…Ù„Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†',
                budget: 'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©',
                noData: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†',
                savingsGoals: 'Ø£Ù‡Ø¯Ø§Ù Ø§Ù„ØªÙˆÙÙŠØ±',
                noGoals: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‡Ø¯Ø§Ù Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†',
                footer: 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2025',
                configNotSet: 'Ù„Ù… ÙŠØªÙ… ØªÙƒÙˆÙŠÙ† Ù…ÙØ§ØªÙŠØ­ Supabase. Ø£Ø¶Ù Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø¥Ù„Ù‰ Ù…Ù„Ù <code>.env</code> Ø§Ù„Ù…Ø­Ù„ÙŠ. Ø§Ù†Ø¸Ø± README Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª.',
                configDetected: 'ØªÙ… Ø§Ù„ÙƒØ´Ù Ø¹Ù† ØªÙƒÙˆÙŠÙ† Supabase. Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙƒØ§Ù…Ù„ (Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ØºÙŠØ± Ù…Ø¹Ø±ÙˆØ¶Ø©).',
                configError: 'ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù†Ù‚Ø·Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªÙƒÙˆÙŠÙ†: ',
                loginSuccess: 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!',
                signupSuccess: 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!',
                guestMode: 'ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø¶ÙŠÙ',
                passwordMismatch: 'ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©',
                requiredFields: 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„',
                loginError: 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
                signupError: 'ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„',
                logout: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬',
                signupLoginBtnText: 'ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„',
                settings: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
                appearance: 'Ø§Ù„Ù…Ø¸Ù‡Ø±',
                currency_label: 'Ø§Ù„Ø¹Ù…Ù„Ø©',
                notifications_label: 'Ø¥Ø®Ø·Ø§Ø±Ø§Øª',
                tips_label: 'Ù†ØµØ§Ø¦Ø­'
            },
            ru: {
                brand: 'Ğ¡Ñ‚ĞµĞºĞ»ÑĞ½Ğ½Ñ‹Ğ¹ Ğ‘ÑĞ´Ğ¶ĞµÑ‚',
                prototype: 'v1.01',
                login: 'Ğ’Ñ…Ğ¾Ğ´',
                signInUp: 'Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ / Ğ’Ñ…Ğ¾Ğ´',
                continueGuest: 'ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ ĞºĞ°Ğº Ğ³Ğ¾ÑÑ‚ÑŒ',
                googleLogin: 'Google (Supabase)',
                language: 'Ğ¯Ğ·Ñ‹Ğº:',
                tipsOn: 'Ğ¡Ğ¾Ğ²ĞµÑ‚Ñ‹: Ğ’ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾',
                tipsOff: 'Ğ¡Ğ¾Ğ²ĞµÑ‚Ñ‹: ĞÑ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾',
                notifications: 'Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ',
                welcome: 'Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² Ğ¡Ñ‚ĞµĞºĞ»ÑĞ½Ğ½Ñ‹Ğ¹ Ğ‘ÑĞ´Ğ¶ĞµÑ‚',
                intro: 'Ğ­Ğ»ĞµĞ³Ğ°Ğ½Ñ‚Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ñ‚Ğ¾Ñ‚Ğ¸Ğ¿ Ğ±ÑĞ´Ğ¶ĞµÑ‚Ğ° Ğ² ÑÑ‚Ğ¸Ğ»Ğµ ÑÑ‚ĞµĞºĞ»Ğ¾Ğ¼Ğ¾Ñ€Ñ„Ğ¸Ğ·Ğ¼Ğ°. Ğ­Ñ‚Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ¾Ğ±ÑĞ»ÑƒĞ¶Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¼ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ¼ Python.',
                loading: 'Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸â€¦',
                currency: 'Ğ’Ğ°Ğ»ÑÑ‚Ğ°',
                noCurrencies: 'Ğ’Ğ°Ğ»ÑÑ‚Ñ‹ ĞµÑ‰Ğµ Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ñ‹',
                budget: 'Ğ‘ÑĞ´Ğ¶ĞµÑ‚',
                noData: 'ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…',
                savingsGoals: 'Ğ¦ĞµĞ»Ğ¸ Ğ¡Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ¸Ğ¹',
                noGoals: 'ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ñ†ĞµĞ»ĞµĞ¹',
                footer: 'Ğ’ÑĞµ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ·Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ñ‹ Â© 2025',
                configNotSet: 'ĞšĞ»ÑÑ‡Ğ¸ Supabase Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ñ‹. Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ ĞºĞ»ÑÑ‡Ğ¸ Ğ² Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ» <code>.env</code>. Ğ¡Ğ¼. README Ğ´Ğ»Ñ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¹.',
                configDetected: 'ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Supabase Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ°. Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾ Ğº Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ (ĞºĞ»ÑÑ‡Ğ¸ Ğ½Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ñ‹).',
                configError: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ ĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾Ğ¹ Ñ‚Ğ¾Ñ‡ĞºĞ¸ config: ',
                loginSuccess: 'Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ²Ğ¾ÑˆĞ»Ğ¸!',
                signupSuccess: 'Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹!',
                guestMode: 'Ğ’ĞºĞ»ÑÑ‡ĞµĞ½ Ñ€ĞµĞ¶Ğ¸Ğ¼ Ğ³Ğ¾ÑÑ‚Ñ',
                passwordMismatch: 'ĞŸĞ°Ñ€Ğ¾Ğ»Ğ¸ Ğ½Ğµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ÑÑ‚',
                requiredFields: 'ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ²ÑĞµ Ğ¿Ğ¾Ğ»Ñ',
                loginError: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ°',
                signupError: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸',
                logout: 'Ğ’Ñ‹Ñ…Ğ¾Ğ´',
                signupLoginBtnText: 'Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ / Ğ’Ñ…Ğ¾Ğ´',
                settings: 'ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹',
                appearance: 'Ğ’Ğ½ĞµÑˆĞ½Ğ¸Ğ¹ Ğ²Ğ¸Ğ´',
                currency_label: 'Ğ’Ğ°Ğ»ÑÑ‚Ğ°',
                notifications_label: 'Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ',
                tips_label: 'Ğ¡Ğ¾Ğ²ĞµÑ‚Ñ‹'
            }
        };

        let currentLang = 'he';
        let authState = { user: null, mode: null };
        let userSettings = {
            theme: 'dark',
            background: null,
            fontFamily: 'Inter, system-ui, Arial',
            contrastIntensity: 1,
            glassOpacity: 1,
            currencies: [],
            primaryCurrency: 'USD',
            enableTips: true,
            tipsDuration: 25,
            tipsEnabled: true,
            tipIntervalSeconds: 33,
            disabledTips: [],
            blockSiteTips: false,
            // Budget
            totalBudget: 0,
            budgetPeriod: 'monthly',
            budgetStartDate: null,
            budgetDuration: 30,
            autoAdjust: true,
            savingsAmount: 0,
            savingsDesc: '',
            savingsDeadline: null,
            reserveAmount: 0,
            // Notifications
            enableNotifications: true,
            notificationFrequency: 'daily',
            notificationHistory: []
        };

        function updatePageLanguage(lang) {
            currentLang = lang;
            const isRTL = (lang === 'he' || lang === 'ar');
            document.documentElement.lang = lang;
            document.documentElement.dir = isRTL ? 'rtl' : 'ltr';
            localStorage.setItem('selectedLanguage', lang);

            const t = translations[lang];
            document.querySelector('.brand').textContent = t.brand;
            document.querySelector('.brand').nextElementSibling.textContent = t.prototype;
            document.querySelector('label[for="loginDrop"]').textContent = t.login;
            const authBtn = document.getElementById('authBtn');
            authBtn.textContent = authState.user ? t.logout : t.signupLoginBtnText;
            document.querySelector('#tipsToggle').textContent = t.tipsOn;
            document.querySelector('#notifBtn').textContent = t.notifications + ' (0)';
            document.querySelector('h1').textContent = t.welcome;
            document.querySelector('p.lead').textContent = t.intro;
            document.querySelector('#configBanner').textContent = t.loading;
            document.querySelectorAll('.glass strong')[0].textContent = t.currency;
            document.querySelectorAll('.glass strong')[1].textContent = t.budget;
            document.querySelectorAll('.glass strong')[2].textContent = t.savingsGoals;
            document.querySelectorAll('p#currencyInfo')[0].textContent = t.noCurrencies;
            document.querySelectorAll('p#budgetInfo')[0].textContent = t.noData;
            document.querySelectorAll('p#goalsInfo')[0].textContent = t.noGoals;
            document.querySelector('.footer').textContent = t.footer;
            
            // Update document title
            const titleMap = {
                he: '×ª×§×¦×™×‘ ×–×›×•×›×™×ª â€” v1.01',
                en: 'Glass Budget â€” v1.01',
                ar: 'Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø²Ø¬Ø§Ø¬ â€” v1.01',
                ru: 'Ğ¡Ñ‚ĞµĞºĞ»ÑĞ½Ğ½Ñ‹Ğ¹ Ğ‘ÑĞ´Ğ¶ĞµÑ‚ â€” v1.01'
            };
            document.title = titleMap[lang] || 'Glass Budget â€” v1.01';
            
            // Update auth modal labels
            const authTitleMap = {
                he: '×”×¨×©××” / ×›× ×™×¡×”',
                en: 'Sign in / Sign up',
                ar: 'ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„',
                ru: 'Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ / Ğ’Ñ…Ğ¾Ğ´'
            };
            
            const emailPlaceholderMap = {
                he: '×“×•××¨ ××œ×§×˜×¨×•× ×™',
                en: 'Email',
                ar: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',
                ru: 'Ğ­Ğ»ĞµĞºÑ‚Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ Ğ¿Ğ¾Ñ‡Ñ‚Ğ°'
            };
            
            const passwordPlaceholderMap = {
                he: '×¡×™×¡××”',
                en: 'Password',
                ar: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
                ru: 'ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ'
            };
            
            const usernameMap = {
                he: '×©× ××©×ª××©',
                en: 'Username',
                ar: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
                ru: 'Ğ˜Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ'
            };
            
            const confirmMap = {
                he: '××™×©×•×¨ ×¡×™×¡××”',
                en: 'Confirm password',
                ar: 'ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
                ru: 'ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ'
            };
            
            const loginBtnMap = {
                he: '×›× ×™×¡×”',
                en: 'Login',
                ar: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
                ru: 'Ğ’Ñ…Ğ¾Ğ´'
            };
            
            const signupBtnMap = {
                he: '×”×¨×©××”',
                en: 'Sign up',
                ar: 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨',
                ru: 'Ğ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ'
            };
            
            document.getElementById('authTitle').textContent = authTitleMap[lang] || 'Sign in / Sign up';
            document.getElementById('loginEmail').placeholder = emailPlaceholderMap[lang] || 'Email';
            document.getElementById('loginPassword').placeholder = passwordPlaceholderMap[lang] || 'Password';
            document.getElementById('loginBtn').textContent = loginBtnMap[lang] || 'Login';
            document.getElementById('signupEmail').placeholder = emailPlaceholderMap[lang] || 'Email';
            document.getElementById('signupUsername').placeholder = usernameMap[lang] || 'Username';
            document.getElementById('signupPassword').placeholder = passwordPlaceholderMap[lang] || 'Password';
            document.getElementById('signupConfirm').placeholder = confirmMap[lang] || 'Confirm password';
            document.getElementById('signupBtn').textContent = signupBtnMap[lang] || 'Sign up';
        }

        function openAuthModal() {
            document.getElementById('authModal').classList.add('active');
        }

        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
        }

        function switchToLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
        }

        function switchToSignup() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
        }

        function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const errorEl = document.getElementById('loginError');
            const t = translations[currentLang];

            if (!email || !password) {
                errorEl.textContent = t.requiredFields;
                return;
            }

            // Simulate local login (in production, use Supabase)
            authState.user = { email, username: email.split('@')[0], mode: 'email' };
            localStorage.setItem('authState', JSON.stringify(authState));
            errorEl.textContent = '';
            alert(t.loginSuccess);
            closeAuthModal();
            updateAuthButton();
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function handleSignup() {
            const email = document.getElementById('signupEmail').value.trim();
            const username = document.getElementById('signupUsername').value.trim();
            const password = document.getElementById('signupPassword').value.trim();
            const confirm = document.getElementById('signupConfirm').value.trim();
            const errorEl = document.getElementById('signupError');
            const t = translations[currentLang];

            if (!email || !username || !password || !confirm) {
                errorEl.textContent = t.requiredFields;
                return;
            }

            if (password !== confirm) {
                errorEl.textContent = t.passwordMismatch;
                return;
            }

            // Simulate local signup (in production, use Supabase)
            authState.user = { email, username, mode: 'email' };
            localStorage.setItem('authState', JSON.stringify(authState));
            errorEl.textContent = '';
            alert(t.signupSuccess);
            closeAuthModal();
            updateAuthButton();
            document.getElementById('signupEmail').value = '';
            document.getElementById('signupUsername').value = '';
            document.getElementById('signupPassword').value = '';
            document.getElementById('signupConfirm').value = '';
        }

        function handleGuestMode() {
            const t = translations[currentLang];
            authState.mode = 'guest';
            localStorage.setItem('authState', JSON.stringify(authState));
            alert(t.guestMode);
            closeAuthModal();
            updateAuthButton();
        }

        function handleGoogleLogin() {
            const googleMessages = {
                he: '×›× ×™×¡×” ×¢× Google ×ª×™×•×©× ×‘×¢×ª ×”×ª×—×‘×¨×•×ª ×œÖ¾Supabase',
                en: 'Google login will be implemented when connected to Supabase',
                ar: 'Ø³ÙŠØªÙ… ØªÙ†ÙÙŠØ° ØªØ³Ø¬ÙŠÙ„ Google Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase',
                ru: 'Ğ’Ñ…Ğ¾Ğ´ Google Ğ±ÑƒĞ´ĞµÑ‚ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¸ Ğº Supabase'
            };
            alert(googleMessages[currentLang] || 'Google login will be implemented when connected to Supabase');
        }

        function updateAuthButton() {
            const btn = document.getElementById('authBtn');
            const t = translations[currentLang];
            if (authState.user || authState.mode === 'guest') {
                btn.textContent = t.logout;
                btn.onclick = handleLogout;
            } else {
                btn.textContent = t.signupLoginBtnText;
                btn.onclick = openAuthModal;
            }
        }

        function handleLogout() {
            authState = { user: null, mode: null };
            localStorage.removeItem('authState');
            updateAuthButton();
            const logoutMessages = {
                he: '×”×ª× ×ª×§×ª ×‘×”×¦×œ×—×”',
                en: 'Logged out successfully',
                ar: 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­',
                ru: 'Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ²Ñ‹ÑˆĞ»Ğ¸ Ğ¸Ğ· ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹'
            };
            alert(logoutMessages[currentLang] || 'Logged out successfully');
        }

        // Settings functions
        // Fullscreen Budget Panel Functions
        // ===== BUDGET SETTINGS WORKFLOW FUNCTIONS =====
        
        function openBudgetPanel() {
            const panel = document.getElementById('budget-fullscreen');
            if (panel) {
                panel.classList.add('active');
                loadBudgetData();
                document.body.style.overflow = 'hidden';
            }
        }

        function closeBudgetPanel() {
            const panel = document.getElementById('budget-fullscreen');
            if (panel) {
                // Add closing animation
                panel.classList.add('closing');
                // After animation completes, remove active class and reset
                setTimeout(() => {
                    panel.classList.remove('active', 'closing');
                    document.body.style.overflow = 'auto';
                }, 300);
            }
        }

        function loadBudgetData() {
            // Load Step 1: Total Budget
            const budgetInput = document.getElementById('totalBudgetInput');
            if (budgetInput) budgetInput.value = userSettings.totalBudget || 0;
            
            // Load Step 2: Period
            const periodBtns = document.querySelectorAll('[data-period]');
            periodBtns.forEach(btn => btn.classList.remove('active'));
            const activePeriodBtn = document.querySelector(`[data-period="${userSettings.budgetPeriod || 'monthly'}"]`);
            if (activePeriodBtn) activePeriodBtn.classList.add('active');
            
            // Load Step 4: Savings Goals
            const savingsName = document.getElementById('savingsGoalName');
            const savingsAmount = document.getElementById('savingsGoalAmount');
            const savingsDeadline = document.getElementById('savingsGoalDeadline');
            const savingsNote = document.getElementById('savingsGoalNote');
            
            if (savingsName) savingsName.value = userSettings.savingsDesc || '';
            if (savingsAmount) savingsAmount.value = userSettings.savingsAmount || 0;
            if (savingsDeadline) savingsDeadline.value = userSettings.savingsDeadline || '';
            if (savingsNote) savingsNote.value = userSettings.savingsNote || '';
            
            // Load Step 5: Smart Features
            const autoAdjust = document.getElementById('autoAdjust');
            const enableAlerts = document.getElementById('enableAlerts');
            const enableGraphs = document.getElementById('enableGraphs');
            
            if (autoAdjust) autoAdjust.checked = userSettings.autoAdjust !== false;
            if (enableAlerts) enableAlerts.checked = userSettings.enableAlerts !== false;
            if (enableGraphs) enableGraphs.checked = userSettings.enableGraphs !== false;
            
            // Load category limits if exists
            loadCategoryLimits();
            
            // Update all calculations
            updateAllCalculations();
        }

        function setPeriod(period) {
            // Update active button
            const periodBtns = document.querySelectorAll('[data-period]');
            periodBtns.forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`[data-period="${period}"]`);
            if (activeBtn) activeBtn.classList.add('active');
            
            // If custom period, show date inputs
            const customDateRange = document.getElementById('customDateRange');
            if (customDateRange) {
                if (period === 'custom') {
                    customDateRange.style.display = 'grid';
                } else {
                    customDateRange.style.display = 'none';
                }
            }
            
            userSettings.budgetPeriod = period;
            updateAllCalculations();
        }

        function updateAllCalculations() {
            const totalBudget = parseFloat(document.getElementById('totalBudgetInput')?.value) || 0;
            const period = userSettings.budgetPeriod || 'monthly';
            
            // Calculate days in period
            let daysInPeriod = 30;
            let periodLabel = '×—×•×“×©×™';
            if (period === 'daily') {
                daysInPeriod = 1;
                periodLabel = '×™×•××™';
            } else if (period === 'weekly') {
                daysInPeriod = 7;
                periodLabel = '×©×‘×•×¢×™';
            } else if (period === 'monthly') {
                daysInPeriod = 30;
                periodLabel = '×—×•×“×©×™';
            }
            
            // Calculate days remaining
            const today = new Date();
            let daysRemaining = daysInPeriod;
            if (period !== 'daily' && period !== 'custom') {
                const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                daysRemaining = daysInMonth - today.getDate();
            }
            
            // Calculate daily/weekly allowance
            const dailyAllowance = totalBudget / daysInPeriod;
            const weeklyAllowance = dailyAllowance * 7;
            
            // Calculate total spent
            const totalSpent = (userSettings.transactions || [])
                .filter(tx => tx.type === 'expense')
                .reduce((sum, tx) => sum + parseFloat(tx.amount || 0), 0);
            
            // Calculate remaining balance
            const remainingBalance = totalBudget - totalSpent;
            
            // Update Step 2: Period Stats
            updatePeriodStats(daysInPeriod, daysRemaining, periodLabel);
            
            // Update Step 3: Calculations Grid
            updateCalculationsDisplay(dailyAllowance, weeklyAllowance, totalSpent, remainingBalance);
            
            // Update progress bar
            const percentage = totalBudget > 0 ? (totalSpent / totalBudget) * 100 : 0;
            updateProgressBar(percentage);
            
            // Update prediction
            updatePrediction(totalBudget, totalSpent, daysRemaining);
        }

        function updatePeriodStats(daysInPeriod, daysRemaining, periodLabel) {
            const totalDaysEl = document.getElementById('totalDaysInPeriod');
            const remainingDaysEl = document.getElementById('remainingDaysInPeriod');
            const progressEl = document.getElementById('periodProgress');
            
            if (totalDaysEl) totalDaysEl.textContent = daysInPeriod;
            if (remainingDaysEl) remainingDaysEl.textContent = Math.max(daysRemaining, 0);
            
            if (progressEl && daysInPeriod > 0) {
                const progress = ((daysInPeriod - daysRemaining) / daysInPeriod) * 100;
                progressEl.textContent = Math.round(progress) + '%';
            }
        }

        function updateCalculationsDisplay(dailyAllowance, weeklyAllowance, totalSpent, remainingBalance) {
            const currencySymbol = userSettings.primaryCurrency === 'USD' ? '$' : 'â‚ª';
            
            // Daily allowance
            const dailyEl = document.getElementById('calcDaily');
            if (dailyEl) dailyEl.textContent = dailyAllowance.toFixed(2) + ' ' + currencySymbol;
            
            // Weekly allowance
            const weeklyEl = document.getElementById('calcWeekly');
            if (weeklyEl) weeklyEl.textContent = weeklyAllowance.toFixed(2) + ' ' + currencySymbol;
            
            // Total spent
            const spentEl = document.getElementById('calcSpent');
            if (spentEl) spentEl.textContent = totalSpent.toFixed(2) + ' ' + currencySymbol;
            
            // Remaining balance
            const balanceEl = document.getElementById('calcBalance');
            if (balanceEl) balanceEl.textContent = remainingBalance.toFixed(2) + ' ' + currencySymbol;
        }

        function updateProgressBar(percentage) {
            const progressBar = document.getElementById('budgetProgressBar');
            if (progressBar) {
                const fill = progressBar.querySelector('.progress-fill');
                if (fill) {
                    fill.style.width = Math.min(percentage, 100) + '%';
                    fill.classList.remove('warning', 'danger');
                    if (percentage > 90) {
                        fill.classList.add('danger');
                    } else if (percentage > 70) {
                        fill.classList.add('warning');
                    }
                }
            }
            
            // Update progress info
            const infoEl = document.querySelector('#budgetProgressBar ~ .progress-info');
            if (infoEl) {
                infoEl.innerHTML = `<span>${Math.round(percentage)}% ×”×•×¦××”</span><span>${100 - Math.round(percentage)}% ×–××™×Ÿ</span>`;
            }
        }

        function updatePrediction(totalBudget, totalSpent, daysRemaining) {
            const predictionBox = document.getElementById('predictionBox');
            if (!predictionBox) return;
            
            if (totalBudget === 0) {
                predictionBox.innerHTML = '<span class="info-icon">â„¹ï¸</span><span class="info-text">×”×’×“×¨ ×ª×§×¦×™×‘ ×›×“×™ ×œ×§×‘×œ ×—×™×–×•×™</span>';
                predictionBox.className = 'info-box';
                return;
            }
            
            const remainingBudget = totalBudget - totalSpent;
            const avgSpendPerDay = totalSpent > 0 ? totalSpent / 30 : 0;
            const projectedFinalSpend = avgSpendPerDay * daysRemaining;
            
            let message = '';
            let iconClass = '';
            
            if (remainingBudget < 0) {
                message = `âš ï¸ ×—×¨×’×ª ××ª ×”×ª×§×¦×™×‘ ×‘-${Math.abs(remainingBudget).toFixed(2)}`;
                iconClass = 'danger';
            } else if (projectedFinalSpend > totalBudget) {
                const overage = projectedFinalSpend - totalBudget;
                message = `âš ï¸ ×× ×ª××©×™×š ×‘×§×¦×‘ ×–×”, ×ª×—×¨×•×’ ×‘-${overage.toFixed(2)}`;
                iconClass = 'warning';
            } else {
                const surplus = remainingBudget - projectedFinalSpend;
                message = `âœ“ ×‘×¢×§×‘×•×ª × ×ª×•× ×™× × ×•×›×—×™×™×, ×™×™×©××¨ ×œ×š ${surplus.toFixed(2)}`;
                iconClass = '';
            }
            
            predictionBox.className = 'info-box' + (iconClass ? ' ' + iconClass : '');
            predictionBox.innerHTML = `<span class="info-icon">${iconClass ? 'âš ï¸' : 'âœ“'}</span><span class="info-text">${message}</span>`;
        }

        function toggleCollapsible(element) {
            const header = element.querySelector('.collapsible-header');
            const content = element.querySelector('.collapsible-content');
            const icon = header.querySelector('.collapsible-icon');
            
            if (!content) return;
            
            content.classList.toggle('active');
            if (icon) {
                icon.style.transform = content.classList.contains('active') ? 'rotate(180deg)' : 'rotate(0deg)';
            }
        }

        function addCategoryLimitRow() {
            const container = document.getElementById('categoryLimitsContainer');
            if (!container) return;
            
            const rowId = 'categoryRow_' + Date.now();
            const categoryOptions = `
                <option value="××–×•×Ÿ">××–×•×Ÿ</option>
                <option value="×ª×—×‘×•×¨×”">×ª×—×‘×•×¨×”</option>
                <option value="×‘×™×“×•×¨">×‘×™×“×•×¨</option>
                <option value="×‘×¨×™××•×ª">×‘×¨×™××•×ª</option>
                <option value="××œ×‘×•×©">××œ×‘×•×©</option>
                <option value="×—×©××œ">×—×©××œ</option>
                <option value="××—×¨">××—×¨</option>
            `;
            
            const row = document.createElement('div');
            row.id = rowId;
            row.style.display = 'grid';
            row.style.gridTemplateColumns = '1fr 1fr 40px';
            row.style.gap = '10px';
            row.style.marginBottom = '10px';
            
            row.innerHTML = `
                <select class="categorySelect" style="padding:10px;background:rgba(255,255,255,0.04);border:1px solid rgba(126,231,199,0.15);border-radius:8px;color:inherit;">${categoryOptions}</select>
                <input type="number" class="categoryLimit" placeholder="×”×’×‘×œ×”" min="0" style="padding:10px;background:rgba(255,255,255,0.04);border:1px solid rgba(126,231,199,0.15);border-radius:8px;color:inherit;">
                <button onclick="removeCategoryRow('${rowId}')" style="padding:10px;background:rgba(255,107,107,0.1);border:1px solid rgba(255,107,107,0.3);border-radius:8px;color:#FF6B6B;cursor:pointer;font-weight:600;">âœ•</button>
            `;
            
            container.appendChild(row);
        }

        function removeCategoryRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) row.remove();
        }

        function loadCategoryLimits() {
            const container = document.getElementById('categoryLimitsContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (userSettings.categoryLimits && Object.keys(userSettings.categoryLimits).length > 0) {
                Object.entries(userSettings.categoryLimits).forEach(([category, limit], index) => {
                    const rowId = 'categoryRow_' + index;
                    const row = document.createElement('div');
                    row.id = rowId;
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = '1fr 1fr 40px';
                    row.style.gap = '10px';
                    row.style.marginBottom = '10px';
                    
                    row.innerHTML = `
                        <select class="categorySelect" style="padding:10px;background:rgba(255,255,255,0.04);border:1px solid rgba(126,231,199,0.15);border-radius:8px;color:inherit;">
                            <option value="${category}" selected>${category}</option>
                            <option value="××–×•×Ÿ">××–×•×Ÿ</option>
                            <option value="×ª×—×‘×•×¨×”">×ª×—×‘×•×¨×”</option>
                            <option value="×‘×™×“×•×¨">×‘×™×“×•×¨</option>
                            <option value="×‘×¨×™××•×ª">×‘×¨×™××•×ª</option>
                            <option value="××œ×‘×•×©">××œ×‘×•×©</option>
                            <option value="×—×©××œ">×—×©××œ</option>
                            <option value="××—×¨">××—×¨</option>
                        </select>
                        <input type="number" class="categoryLimit" value="${limit}" min="0" style="padding:10px;background:rgba(255,255,255,0.04);border:1px solid rgba(126,231,199,0.15);border-radius:8px;color:inherit;">
                        <button onclick="removeCategoryRow('${rowId}')" style="padding:10px;background:rgba(255,107,107,0.1);border:1px solid rgba(255,107,107,0.3);border-radius:8px;color:#FF6B6B;cursor:pointer;font-weight:600;">âœ•</button>
                    `;
                    
                    container.appendChild(row);
                });
            }
        }

        function finalizeBudgetSettings() {
            // Save Step 1: Total Budget
            userSettings.totalBudget = parseFloat(document.getElementById('totalBudgetInput')?.value) || 0;
            
            // Save Step 2: Period
            userSettings.budgetPeriod = userSettings.budgetPeriod || 'monthly';
            
            // Save Step 4: Savings Goals
            userSettings.savingsDesc = document.getElementById('savingsGoalName')?.value || '';
            userSettings.savingsAmount = parseFloat(document.getElementById('savingsGoalAmount')?.value) || 0;
            userSettings.savingsDeadline = document.getElementById('savingsGoalDeadline')?.value || '';
            userSettings.savingsNote = document.getElementById('savingsGoalNote')?.value || '';
            
            // Save Step 5: Smart Features
            userSettings.autoAdjust = document.getElementById('autoAdjust')?.checked || false;
            userSettings.enableAlerts = document.getElementById('enableAlerts')?.checked || false;
            userSettings.enableGraphs = document.getElementById('enableGraphs')?.checked || false;
            
            // Save category limits
            userSettings.categoryLimits = {};
            const categoryRows = document.querySelectorAll('#categoryLimitsContainer > div');
            categoryRows.forEach(row => {
                const select = row.querySelector('.categorySelect');
                const input = row.querySelector('.categoryLimit');
                if (select && input) {
                    const category = select.value;
                    const limit = parseFloat(input.value) || 0;
                    userSettings.categoryLimits[category] = limit;
                }
            });
            
            // Save to localStorage
            localStorage.setItem('userSettings', JSON.stringify(userSettings));
            
            // Show success message via tips (before closing so it appears)
            showTip('×”×’×“×¨×•×ª ×”×ª×§×¦×™×‘ × ×©××¨×• ×‘×”×¦×œ×—×”! âœ“');
            
            // Close panel with animation
            closeBudgetPanel();
        }

        // Add Transaction Modal Functions
        let currentTransactionType = 'expense';

        function openAddTransactionModal() {
            const modal = document.getElementById('add-transaction-modal');
            if (modal) {
                modal.classList.add('active');
                // Set today's date as default
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('txDate').value = today;
            }
        }

        function closeAddTransactionModal() {
            const modal = document.getElementById('add-transaction-modal');
            if (modal) {
                modal.classList.remove('active');
            }
            // Clear form
            document.getElementById('txTitle').value = '';
            document.getElementById('txAmount').value = '';
            document.getElementById('txNote').value = '';
        }

        function setTransactionType(type) {
            currentTransactionType = type;
            document.getElementById('typeExpense').classList.toggle('active', type === 'expense');
            document.getElementById('typeIncome').classList.toggle('active', type === 'income');
        }

        function saveTransaction() {
            const title = document.getElementById('txTitle').value.trim();
            const category = document.getElementById('txCategory').value;
            const amount = parseFloat(document.getElementById('txAmount').value);
            const date = document.getElementById('txDate').value;
            const note = document.getElementById('txNote').value.trim();
            
            if (!title || !amount || !date) {
                alert('×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');
                return;
            }
            
            if (!userSettings.transactions) {
                userSettings.transactions = [];
            }
            
            const transaction = {
                id: Date.now(),
                type: currentTransactionType,
                title,
                category,
                amount,
                date,
                note,
                createdAt: new Date().toISOString()
            };
            
            userSettings.transactions.push(transaction);
            localStorage.setItem('userSettings', JSON.stringify(userSettings));
            
            closeAddTransactionModal();
            updateBudgetStats();
            
            // Show success message
            const msg = currentTransactionType === 'expense' ? '×”×•×¦××” × ×•×¡×¤×” ×‘×”×¦×œ×—×”' : '×”×›× ×¡×” × ×•×¡×¤×” ×‘×”×¦×œ×—×”';
            alert(msg);
        }

        function openPopup(popupId) {
            // Close any open popups first
            document.querySelectorAll('.settings-popup').forEach(p => p.classList.remove('active'));
            // Mark icon as active
            document.querySelectorAll('.icon-btn').forEach(btn => btn.classList.remove('active'));
            const iconMap = {
                'budget-popup': 'icon-budget',
                'design-popup': 'icon-design',
                'language-popup': 'icon-language',
                'notifications-popup': 'icon-notifications',
                'tips-popup': 'icon-tips',
                'account-popup': 'icon-account'
            };
            if (iconMap[popupId]) {
                const iconBtn = document.getElementById(iconMap[popupId]);
                if (iconBtn) {
                    iconBtn.classList.add('active');
                }
            }
            // Update account popup before opening if it's the account popup
            if (popupId === 'account-popup') {
                updateAccountPopup();
            }
            const popup = document.getElementById(popupId);
            if (popup) {
                popup.classList.add('active');
            }
        }

        function updateAccountPopup() {
            const accountStatus = document.getElementById('accountStatus');
            if (accountStatus) {
                if (authState.user) {
                    accountStatus.textContent = (currentLang === 'he') ? '××—×•×‘×¨: ' + authState.user : 'Logged in: ' + authState.user;
                } else if (authState.mode === 'guest') {
                    accountStatus.textContent = (currentLang === 'he') ? '××•×¨×—' : 'Guest';
                } else {
                    accountStatus.textContent = (currentLang === 'he') ? '×œ× ××—×•×‘×¨' : 'Not logged in';
                }
            }
        }

        function closePopup(popupId) {
            const popup = document.getElementById(popupId);
            if (popup) popup.classList.remove('active');
            document.querySelectorAll('.icon-btn').forEach(btn => btn.classList.remove('active'));
        }

        function closeAllPopups() {
            document.querySelectorAll('.settings-popup').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.icon-btn').forEach(btn => btn.classList.remove('active'));
        }

        function logOutUser() {
            authState = { user: null, mode: 'guest' };
            localStorage.removeItem('authState');
            updateAuthButton();
            updateAccountPopup();
            closePopup('account-popup');
        }

        function openSettingsModal() {
            document.getElementById('settingsModal').classList.add('active');
            loadUserSettings();
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function saveSettings() {
            localStorage.setItem('userSettings', JSON.stringify(userSettings));
        }

        function changeTheme(theme) {
            userSettings.theme = theme;
            saveSettings();
            applyTheme(theme);
        }

        function applyTheme(theme) {
            const page = document.querySelector('.page');
            page.style.background = '';
            page.style.backgroundAttachment = '';
            if (theme === 'light') {
                page.style.background = 'linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%)';
                document.documentElement.style.colorScheme = 'light';
            } else if (theme === 'dark') {
                page.style.background = 'linear-gradient(135deg, #0f172a 0%, #0b1220 100%)';
                document.documentElement.style.colorScheme = 'dark';
            } else if (theme === 'transparent') {
                page.style.background = 'rgba(15, 23, 42, 0.5)';
                page.style.backgroundAttachment = 'fixed';
            }
            if (userSettings.background) {
                if (userSettings.background.startsWith('http')) {
                    page.style.backgroundImage = `url('${userSettings.background}')`;
                    page.style.backgroundSize = 'cover';
                    page.style.backgroundPosition = 'center';
                }
            }
            // Apply opacity to CSS variables
            document.documentElement.style.setProperty('--opacity', userSettings.glassOpacity || 1);
        }

        function handleBgUpload() {
            const file = document.getElementById('bgUpload').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    userSettings.background = e.target.result;
                    saveSettings();
                    applyTheme(userSettings.theme);
                };
                reader.readAsDataURL(file);
            }
        }

        function handleBgUrl() {
            const url = document.getElementById('bgUrl').value.trim();
            if (url) {
                userSettings.background = url;
                saveSettings();
                applyTheme(userSettings.theme);
            }
        }

        function resetBackground() {
            userSettings.background = null;
            document.getElementById('bgUpload').value = '';
            document.getElementById('bgUrl').value = '';
            saveSettings();
            applyTheme(userSettings.theme);
        }

        function loadUserSettings() {
            const saved = localStorage.getItem('userSettings');
            if (saved) {
                try {
                    userSettings = JSON.parse(saved);
                } catch (e) {
                    console.log('Failed to load settings');
                }
            }
            // Update UI based on settings (defensive checks for elements)
            try {
                const themeEl = document.querySelector(`input[name="theme"][value="${userSettings.theme}"]`);
                if (themeEl) themeEl.checked = true;
            } catch (e) {}
            const el_enableTips2 = document.getElementById('enableTips2'); if (el_enableTips2) el_enableTips2.checked = !!userSettings.tipsEnabled;
            const el_enableNotif = document.getElementById('enableNotif'); if (el_enableNotif) el_enableNotif.checked = !!userSettings.enableNotifications;
            const el_tipsDuration2 = document.getElementById('tipsDuration2'); if (el_tipsDuration2) el_tipsDuration2.value = userSettings.tipsDuration;
            const el_durationValue2 = document.getElementById('durationValue2'); if (el_durationValue2) el_durationValue2.textContent = (userSettings.tipsDuration || 25) + ' ×©× ';
            const el_glassOpacity = document.getElementById('glassOpacity'); if (el_glassOpacity) el_glassOpacity.value = userSettings.glassOpacity || 1;
            const el_opacityValue = document.getElementById('opacityValue'); if (el_opacityValue) el_opacityValue.textContent = Math.round((userSettings.glassOpacity || 1) * 100) + '%';
            document.documentElement.style.setProperty('--opacity', userSettings.glassOpacity || 1);
            const el_primaryCurrency = document.getElementById('primaryCurrency'); if (el_primaryCurrency) el_primaryCurrency.value = userSettings.primaryCurrency;
            const el_totalBudget = document.getElementById('totalBudget'); if (el_totalBudget) el_totalBudget.value = userSettings.totalBudget;
            const el_budgetPeriod = document.getElementById('budgetPeriod'); if (el_budgetPeriod) el_budgetPeriod.value = userSettings.budgetPeriod;
            const el_budgetStartDate = document.getElementById('budgetStartDate'); if (el_budgetStartDate) el_budgetStartDate.value = userSettings.budgetStartDate || '';
            const el_budgetDuration = document.getElementById('budgetDuration'); if (el_budgetDuration) el_budgetDuration.value = userSettings.budgetDuration;
            const el_autoAdjust = document.getElementById('autoAdjust'); if (el_autoAdjust) el_autoAdjust.checked = !!userSettings.autoAdjust;
            const el_savingsAmount = document.getElementById('savingsAmount'); if (el_savingsAmount) el_savingsAmount.value = userSettings.savingsAmount;
            const el_savingsDesc = document.getElementById('savingsDesc'); if (el_savingsDesc) el_savingsDesc.value = userSettings.savingsDesc;
            const el_savingsDeadline = document.getElementById('savingsDeadline'); if (el_savingsDeadline) el_savingsDeadline.value = userSettings.savingsDeadline || '';
            const el_reserveAmount = document.getElementById('reserveAmount'); if (el_reserveAmount) el_reserveAmount.value = userSettings.reserveAmount;
            try { const nf = document.querySelector(`input[name="notifFreq"][value="${userSettings.notificationFrequency}"]`); if (nf) nf.checked = true; } catch (e) {}
            // ensure expected arrays/shape exist
            userSettings.transactions = Array.isArray(userSettings.transactions) ? userSettings.transactions : [];
            userSettings.notificationHistory = Array.isArray(userSettings.notificationHistory) ? userSettings.notificationHistory : [];
            userSettings.disabledTips = Array.isArray(userSettings.disabledTips) ? userSettings.disabledTips : [];
            userSettings.currencies = Array.isArray(userSettings.currencies) ? userSettings.currencies : [];
            // tips specific
            const el_tipsFrequency = document.getElementById('tipsFrequency'); if (el_tipsFrequency) el_tipsFrequency.value = userSettings.tipIntervalSeconds || 33;
            const el_blockSiteTips = document.getElementById('blockSiteTips'); if (el_blockSiteTips) el_blockSiteTips.checked = !!userSettings.blockSiteTips;
            // update top-right label and start/stop tips based on setting
            updateTipsToggleLabel();
            if (userSettings.tipsEnabled) startTipsLoop(); else stopTipsLoop();
            renderCurrencyList2();
            renderNotificationHistory();
            renderTipList();
            // update budget display and transaction list
            renderTransactionList();
            updateBudgetDisplay();
        }

        function changeLanguageSetting() {
            const lang = document.getElementById('settingsLang').value;
            updatePageLanguage(lang);
            document.getElementById('langSel').value = lang;
        }

        function setPrimaryCurrency() {
            const curr = document.getElementById('primaryCurrency').value;
            userSettings.primaryCurrency = curr;
            saveSettings();
        }

        function addCurrency2() {
            const select = document.getElementById('currencySelect2');
            const currency = select.value;
            if (!currency || userSettings.currencies.includes(currency)) {
                return;
            }
            userSettings.currencies.push(currency);
            saveSettings();
            renderCurrencyList2();
            select.value = '';
        }

        function removeCurrency2(curr) {
            userSettings.currencies = userSettings.currencies.filter(c => c !== curr);
            saveSettings();
            renderCurrencyList2();
        }

        function renderCurrencyList2() {
            const list = document.getElementById('currencyList2');
            if (userSettings.currencies.length === 0) {
                list.innerHTML = '<p style="color:#aaa">××™×Ÿ</p>';
            } else {
                list.innerHTML = userSettings.currencies.map(curr => `
                    <div class="currency-item">
                        <span>${curr}</span>
                        <button onclick="removeCurrency2('${curr}')">×”×¡×¨</button>
                    </div>
                `).join('');
            }
        }

        function saveBudgetSettings() {
            userSettings.totalBudget = parseFloat(document.getElementById('totalBudget').value) || 0;
            userSettings.budgetPeriod = document.getElementById('budgetPeriod').value;
            userSettings.budgetStartDate = document.getElementById('budgetStartDate').value;
            userSettings.budgetDuration = parseInt(document.getElementById('budgetDuration').value) || 30;
            userSettings.autoAdjust = document.getElementById('autoAdjust').checked;
            userSettings.savingsAmount = parseFloat(document.getElementById('savingsAmount').value) || 0;
            userSettings.savingsDesc = document.getElementById('savingsDesc').value;
            userSettings.savingsDeadline = document.getElementById('savingsDeadline').value;
            userSettings.reserveAmount = parseFloat(document.getElementById('reserveAmount').value) || 0;
            saveSettings();
            // Update budget calculations / dashboard
            updateBudgetDisplay();
        }

        function toggleNotifications() {
            userSettings.enableNotifications = document.getElementById('enableNotif').checked;
            saveSettings();
        }

        function saveNotifSettings() {
            userSettings.notificationFrequency = document.querySelector('input[name="notifFreq"]:checked').value;
            saveSettings();
        }

        function sendTestNotification() {
            const now = new Date().toLocaleString();
            const msg = { time: now, text: '×–×• ×”×•×“×¢×ª ×‘×“×™×§×” ×Ö¾×ª×§×¦×™×‘ ×–×›×•×›×™×ª' };
            userSettings.notificationHistory.unshift(msg);
            if (userSettings.notificationHistory.length > 10) {
                userSettings.notificationHistory.pop();
            }
            saveSettings();
            renderNotificationHistory();
            alert('×”×•×“×¢×ª ×‘×“×™×§×” × ×©×œ×—×”!');
        }

        function renderNotificationHistory() {
            const hist = document.getElementById('notifHistory');
            if (userSettings.notificationHistory.length === 0) {
                hist.innerHTML = '<p style="color:#aaa">××™×Ÿ ×”×•×“×¢×•×ª ×¢×“×™×™×Ÿ</p>';
            } else {
                hist.innerHTML = userSettings.notificationHistory.map(n => `
                    <div style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.1);margin:4px 0">
                        <div style="color:#aaa;font-size:0.75rem">${n.time}</div>
                        <div>${n.text}</div>
                    </div>
                `).join('');
            }
        }

        // --- Budget engine: transactions, summaries and dashboard rendering ---
        // Transactions stored in userSettings.transactions as {amount, currency, date, desc}
        if (!Array.isArray(userSettings.transactions)) userSettings.transactions = [];

        function addTransaction(tx) {
            if (!tx || isNaN(parseFloat(tx.amount))) return false;
            if (!Array.isArray(userSettings.transactions)) {
                // defensive init in case loadUserSettings replaced settings without transactions
                userSettings.transactions = [];
            }
            // normalize
            const type = tx.type === 'income' ? 'income' : 'expense';
            const category = tx.category || '';
            userSettings.transactions.unshift({
                amount: parseFloat(tx.amount),
                currency: tx.currency || userSettings.primaryCurrency || 'USD',
                date: tx.date || new Date().toISOString().slice(0,10),
                desc: tx.desc || '',
                type,
                category
            });
            // keep recent 500
            if (userSettings.transactions.length > 500) userSettings.transactions.length = 500;
            saveSettings();
            updateBudgetDisplay();
            renderTransactionList();
            return true;
        }

        function _elValue(id, fallback = '') {
            const el = document.getElementById(id);
            return el ? el.value : fallback;
        }

        function addTransactionFromUI(){
            try {
                const raw = _elValue('txAmount', '').toString().trim();
                // accept comma as decimal separator
                const normalized = raw.replace(',', '.');
                const amt = parseFloat(normalized);
                if (isNaN(amt)) {
                    const t = translations[currentLang] || translations['en'];
                    alert(currentLang === 'he' ? '× × ×œ×”×–×™×Ÿ ×¡×›×•× ×—×•×§×™' : (currentLang === 'es' ? 'Por favor ingrese una cantidad vÃ¡lida' : 'Please enter a valid amount'));
                    return;
                }
                const tx = {
                    amount: Math.abs(amt),
                    type: _elValue('txType', 'expense') || 'expense',
                    currency: _elValue('txCurrency', userSettings.primaryCurrency || 'USD'),
                    date: _elValue('txDate', new Date().toISOString().slice(0,10)),
                    category: _elValue('txCategory', ''),
                    desc: _elValue('txDesc', '')
                };
                const ok = addTransaction(tx);
                if (!ok) throw new Error('Failed to add transaction');
                // clear inputs if present
                const amtEl = document.getElementById('txAmount'); if (amtEl) amtEl.value = '';
                const descEl = document.getElementById('txDesc'); if (descEl) descEl.value = '';
                const dateEl = document.getElementById('txDate'); if (dateEl) dateEl.value = '';
                const catEl = document.getElementById('txCategory'); if (catEl) catEl.value = '';
            } catch (err) {
                console.error('addTransactionFromUI error', err);
                const msg = (err && err.message) ? err.message : 'unknown';
                const t = translations[currentLang] || translations['en'];
                alert((currentLang === 'he') ? ('×©×’×™××” ×‘×”×•×¡×¤×ª ×¢×¡×§×” â€” ' + msg) : ((currentLang === 'es') ? ('Error al agregar la transacciÃ³n â€” ' + msg) : ('Error adding transaction â€” ' + msg)));
            }
        }

        function removeTransactionAt(idx){
            if (idx < 0 || idx >= userSettings.transactions.length) return;
            userSettings.transactions.splice(idx,1);
            saveSettings();
            renderTransactionList();
            updateBudgetDisplay();
        }

        function renderTransactionList(){
            const el = document.getElementById('txList');
            if (!el) return;
            if (!userSettings.transactions || userSettings.transactions.length === 0) {
                el.innerHTML = '<p style="color:#aaa">××™×Ÿ ×”×•×¦××•×ª ×¢×“×™×™×Ÿ</p>';
                return;
            }
            el.innerHTML = userSettings.transactions.map((t, i) => {
                const isIncome = (t.type === 'income');
                const color = isIncome ? 'rgba(72,187,120,0.12)' : 'rgba(255,99,99,0.06)';
                const badge = isIncome ? '×”×›× ×¡×”' : '×”×•×¦××”';
                const sign = isIncome ? '+' : '-';
                return `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);background:${color};">
                    <div style="font-size:0.95rem">${t.date} â€” ${sign}${t.amount.toFixed(2)} ${t.currency} <div style='font-size:0.85rem;color:#aaa'>${t.category ? '['+t.category+'] ' : ''}${t.desc || ''}</div></div>
                    <div><button class="btn" onclick="removeTransactionAt(${i})">×”×¡×¨</button></div>
                </div>
            `; }).join('');
        }

        function computeBudgetSummary(){
            const totalBudget = parseFloat(userSettings.totalBudget) || 0;
            const start = userSettings.budgetStartDate ? new Date(userSettings.budgetStartDate) : new Date();
            const duration = parseInt(userSettings.budgetDuration) || 30;
            const end = new Date(start.getTime()); end.setDate(start.getDate() + duration - 1);
            const today = new Date();
            // calculate spent and income within period
            let expenses = 0;
            let income = 0;
            (userSettings.transactions || []).forEach(t => {
                try {
                    const d = new Date(t.date);
                    if (d >= start && d <= end) {
                        if (t.type === 'income') income += parseFloat(t.amount) || 0;
                        else expenses += parseFloat(t.amount) || 0;
                    }
                } catch (e) {}
            });
            const reserve = parseFloat(userSettings.reserveAmount) || 0;
            // remaining budget (for spending) - incomes do not directly reduce budget but are shown separately
            const remaining = Math.max(0, totalBudget - expenses - reserve);
            // overall net during period
            const net = income - expenses;
            // remaining days (including today)
            const msPerDay = 24*60*60*1000;
            const remDays = Math.max(1, Math.ceil((end - today + 1*msPerDay) / msPerDay));
            const dailyAllowance = remaining / remDays;
            return { totalBudget, expenses, income, net, remaining, reserve, start, end, remDays, dailyAllowance };
        }

        function updateBudgetDisplay(){
            const summary = computeBudgetSummary();
            const budgetInfo = document.getElementById('budgetInfo');
            const currency = userSettings.primaryCurrency || 'USD';
            if (budgetInfo) {
                budgetInfo.innerHTML = `
                    <div style="font-size:0.95rem">×¡×”"×› ×ª×§×¦×™×‘: <strong>${summary.totalBudget.toFixed(2)} ${currency}</strong></div>
                    <div style="font-size:0.95rem;color:rgba(255,99,99,0.9)">×¡×”"×› ×”×•×¦××•×ª: <strong>${summary.expenses.toFixed(2)} ${currency}</strong></div>
                    <div style="font-size:0.95rem;color:rgba(72,187,120,0.95)">×¡×”"×› ×”×›× ×¡×•×ª: <strong>${summary.income.toFixed(2)} ${currency}</strong></div>
                    <div style="font-size:0.95rem">×™×ª×¨×ª ×ª×§×•×¤×” (×”×›× ×¡×•×ª - ×”×•×¦××•×ª): <strong>${summary.net.toFixed(2)} ${currency}</strong></div>
                    <div style="font-size:0.95rem">×©××•×¨×” ×‘×¡×•×£: <strong>${summary.reserve.toFixed(2)} ${currency}</strong></div>
                    <div style="font-size:0.95rem">× ×©××¨ ×œ×ª×§×¦×™×‘: <strong>${summary.remaining.toFixed(2)} ${currency}</strong></div>
                    <div style="font-size:0.95rem">×™××™× × ×•×ª×¨×•: <strong>${summary.remDays}</strong></div>
                    <div style="font-size:0.95rem">××©×¨××™ ×™×•××™ ××•××œ×¥: <strong>${summary.dailyAllowance.toFixed(2)} ${currency}</strong></div>
                `;
            }
            const goalsInfo = document.getElementById('goalsInfo');
            if (goalsInfo) {
                goalsInfo.innerHTML = `×™×¢×“ ×—×™×¡×›×•×Ÿ: <strong>${(userSettings.savingsAmount || 0).toFixed(2)} ${currency}</strong> â€” ${userSettings.savingsDesc || '-'} ${userSettings.savingsDeadline ? '×¢×“ ' + userSettings.savingsDeadline : ''}`;
            }
        }

        function toggleTipsGeneral() {
            userSettings.tipsEnabled = document.getElementById('enableTips2').checked;
            setTipsEnabled(userSettings.tipsEnabled);
        }

        function setTipsEnabled(enabled) {
            userSettings.tipsEnabled = !!enabled;
            userSettings.enableTips = !!enabled;
            saveSettings();
            updateTipsToggleLabel();
            if (userSettings.tipsEnabled) startTipsLoop();
            else stopTipsLoop();
            // sync checkboxes in settings
            const e1 = document.getElementById('enableTips');
            const e2 = document.getElementById('enableTips2');
            if (e1) e1.checked = userSettings.tipsEnabled;
            if (e2) e2.checked = userSettings.tipsEnabled;
        }

        function updateTipsToggleLabel() {
            const t = translations[currentLang] || translations['en'];
            const toggle = document.getElementById('tipsToggle');
            if (!toggle) return;
            toggle.textContent = userSettings.tipsEnabled ? t.tipsOn : t.tipsOff;
        }

        function updateTipsDuration2() {
            const val = parseInt(document.getElementById('tipsDuration2').value);
            userSettings.tipsDuration = val;
            document.getElementById('durationValue2').textContent = val + ' ×©× ×™×•×ª';
            saveSettings();
        }

        function resetTips() {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××¤×¡ ××ª ×›×œ ×”×˜×™×¤×™×?')) {
                // Reset tips state
                userSettings.disabledTips = [];
                userSettings.blockSiteTips = false;
                saveSettings();
                renderTipList();
                restartTips();
                alert('×˜×™×¤×™× ×”×•×¤×¢×œ×• ××—×“×©');
            }
        }

        function setTipFrequency() {
            const val = parseInt(document.getElementById('tipsFrequency').value) || 33;
            userSettings.tipIntervalSeconds = val;
            saveSettings();
            restartTips();
        }

        function toggleBlockSiteTips() {
            const checked = document.getElementById('blockSiteTips').checked;
            userSettings.blockSiteTips = !!checked;
            saveSettings();
            restartTips();
        }

        function renderTipList() {
            const list = document.getElementById('tipListSettings');
            const tipsByLang = getTipsForCurrentLang();
            const flat = [];
            ['budget','savings','management','general'].forEach(cat => {
                (tipsByLang[cat] || []).forEach(t => flat.push(t));
            });
            if (flat.length === 0) {
                list.innerHTML = '<p style="color:#aaa">××™×Ÿ ×˜×™×¤×™× ×œ×”×¦×’×”</p>';
                return;
            }
            list.innerHTML = flat.map(t => {
                const disabled = userSettings.disabledTips.includes(t.id);
                const authorTag = t.author === 'site' ? ' (×¦×•×•×ª)' : '';
                return `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:6px;border-bottom:1px solid rgba(255,255,255,0.03)">
                        <div style="font-size:0.92rem">${t.text}${authorTag}</div>
                        <div>
                            <button onclick="toggleTipDisabled('${t.id}')" style="padding:6px 10px">${disabled ? '×”×¤×¢×œ' : '×”×©×‘×ª'}</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleTipDisabled(id) {
            const idx = userSettings.disabledTips.indexOf(id);
            if (idx === -1) userSettings.disabledTips.push(id);
            else userSettings.disabledTips.splice(idx,1);
            saveSettings();
            renderTipList();
            restartTips();
        }

        // --- Tips runtime: show rotating tips according to user settings ---
        let tipsTimer = null;
        let tipHideTimer = null;

        const tipsTemplates = {
            he: {
                budget: [
                    { id: 'he-b1', author: 'site', text: '×§×‘×¢ ×¡×›×•× ×™×•××™ ×§×˜×Ÿ â€” ×–×” ×¢×•×–×¨ ×œ×©××•×¨ ×¢×œ ×¢×§×‘×™×•×ª.' },
                    { id: 'he-b2', author: 'user', text: '×‘×“×•×§ ×”×•×¦××•×ª ×§×˜× ×•×ª â€” ×”×Ÿ ××¦×˜×‘×¨×•×ª ×‘××”×™×¨×•×ª.' }
                ],
                savings: [
                    { id: 'he-s1', author: 'site', text: '×”×’×“×¨ ×™×¢×“ ×—×™×¡×›×•×Ÿ ×—×•×“×©×™ ×§×˜×Ÿ ×•×™×¦×™×‘.' },
                    { id: 'he-s2', author: 'user', text: '×—×¡×•×š ×‘××•×¤×Ÿ ××•×˜×•××˜×™ ×›×œ ×—×•×“×© ×›×“×™ ×œ×”×§×“×™× ××˜×¨×•×ª.' }
                ],
                management: [
                    { id: 'he-m1', author: 'user', text: '×¢×§×•×‘ ××—×¨×™ ×§×˜×’×•×¨×™×•×ª ×”×•×¦××” ×©×™×¢×–×¨×• ×œ×š ×œ×ª×¢×“×£.' },
                    { id: 'he-m2', author: 'user', text: '×§×‘×¢ ×—×•×§×™× ×¤×©×•×˜×™× ×œ×—×™×¡×›×•×Ÿ ×›××• "0.5% ××”××©×›×•×¨×ª".' }
                ],
                general: [
                    { id: 'he-g1', author: 'site', text: '××•××œ×¥ ×œ×”×™×¨×©× ×›×“×™ ×œ×¡× ×›×¨×Ÿ ×‘×™×Ÿ ××›×©×™×¨×™×.' },
                    { id: 'he-g2', author: 'user', text: '× ×¡×” ×œ×”×¤×¢×™×œ ×”×ª×¨××•×ª ×œ×ª×–×›×•×¨×ª ×™×•××™×ª.' }
                ]
            },
            en: {
                budget: [
                    { id: 'en-b1', author: 'site', text: 'Set a small daily amount â€” consistency matters.' },
                    { id: 'en-b2', author: 'user', text: 'Check small expenses â€” they add up fast.' }
                ],
                savings: [
                    { id: 'en-s1', author: 'site', text: 'Set a modest monthly savings goal and automate it.' },
                    { id: 'en-s2', author: 'user', text: 'Automate transfers to build savings without thinking.' }
                ],
                management: [
                    { id: 'en-m1', author: 'user', text: 'Track spending categories to prioritize better.' },
                    { id: 'en-m2', author: 'user', text: 'Create simple saving rules like "5% of income".' }
                ],
                general: [
                    { id: 'en-g1', author: 'site', text: 'Sign in to sync across devices (recommended).' },
                    { id: 'en-g2', author: 'user', text: 'Enable notifications for daily reminders.' }
                ]
            },
            es: {
                budget: [
                    { id: 'es-b1', author: 'site', text: 'Establece una cantidad diaria pequeÃ±a â€” la consistencia importa.' },
                    { id: 'es-b2', author: 'user', text: 'Revisa gastos pequeÃ±os â€” se acumulan rÃ¡pido.' }
                ],
                savings: [
                    { id: 'es-s1', author: 'site', text: 'Fija un objetivo de ahorro mensual y automatÃ­zalo.' },
                    { id: 'es-s2', author: 'user', text: 'Transfiere automÃ¡ticamente para ahorrar sin pensar.' }
                ],
                management: [
                    { id: 'es-m1', author: 'user', text: 'Sigue categorÃ­as de gasto para priorizar mejor.' },
                    { id: 'es-m2', author: 'user', text: 'Crea reglas simples de ahorro, por ejemplo "5% del ingreso".' }
                ],
                general: [
                    { id: 'es-g1', author: 'site', text: 'Inicia sesiÃ³n para sincronizar entre dispositivos (recomendado).' },
                    { id: 'es-g2', author: 'user', text: 'Activa notificaciones para recordatorios diarios.' }
                ]
            }
        };

        function getTipsForCurrentLang() {
            return tipsTemplates[currentLang] || tipsTemplates['en'];
        }

        function isTipCategoryEnabled(catId) {
            // accept both new ids and default to true
            try {
                const el = document.getElementById(catId);
                return el ? el.checked : true;
            } catch (e) { return true; }
        }

        function pickNextTip() {
            const tipsByLang = getTipsForCurrentLang();
            const pool = [];
            if (isTipCategoryEnabled('tip_cat_budget')) pool.push(...(tipsByLang.budget || []));
            if (isTipCategoryEnabled('tip_cat_savings')) pool.push(...(tipsByLang.savings || []));
            if (isTipCategoryEnabled('tip_cat_management')) pool.push(...(tipsByLang.management || []));
            if (isTipCategoryEnabled('tip_cat_general')) pool.push(...(tipsByLang.general || []));

            // filter out disabled tips and optionally block site tips
            const filtered = pool.filter(t => {
                if (!t || !t.id) return false;
                if (userSettings.disabledTips && userSettings.disabledTips.includes(t.id)) return false;
                if (userSettings.blockSiteTips && t.author === 'site') return false;
                return true;
            });

            if (filtered.length === 0) return null;
            // pick random object and return its text
            const pick = filtered[Math.floor(Math.random() * filtered.length)];
            return pick.text || null;
        }

        function showTip(text) {
            const container = document.getElementById('tipContainer');
            const textEl = document.getElementById('tipText');
            if (!container || !textEl) return;
            textEl.innerHTML = text;
            container.style.display = 'block';
            // ensure above modals
            container.style.zIndex = 1300;
            // clear previous hide timer
            if (tipHideTimer) clearTimeout(tipHideTimer);
            const duration = (userSettings.tipsDuration || 25) * 1000;
            tipHideTimer = setTimeout(hideTip, duration);
        }

        function hideTip() {
            const container = document.getElementById('tipContainer');
            if (!container) return;
            container.style.display = 'none';
        }

        function startTipsLoop() {
            stopTipsLoop();
            const enabled = (userSettings.tipsEnabled !== undefined) ? userSettings.tipsEnabled : (userSettings.enableTips || true);
            if (!enabled) return;
            // show initial tip immediately
            const initial = pickNextTip();
            if (initial) {
                // add recommended sign-in tip if not logged in
                let message = initial;
                if (!(authState && authState.user) && message.toLowerCase().indexOf('sync') === -1) {
                    const rec = currentLang === 'he' ? ' â€¢ ××•××œ×¥ ×œ×”×™×¨×©× ×›×“×™ ×œ×¡× ×›×¨×Ÿ ×‘×™×Ÿ ××›×©×™×¨×™×.' : (currentLang === 'es' ? ' â€¢ Recomendado iniciar sesiÃ³n para sincronizar.' : ' â€¢ Recommended to sign in to sync across devices.');
                    message = message + rec;
                }
                showTip(message);
            }
            // schedule repeating tips based on userSettings.tipIntervalSeconds (fallback to tipsDuration+8)
            const interval = userSettings.tipIntervalSeconds || ((userSettings.tipsDuration || 25) + 8);
            const intervalMs = Math.max(5, interval) * 1000;
            tipsTimer = setInterval(() => {
                const next = pickNextTip();
                if (next) showTip(next);
            }, intervalMs);
        }

        function stopTipsLoop() {
            if (tipsTimer) { clearInterval(tipsTimer); tipsTimer = null; }
            if (tipHideTimer) { clearTimeout(tipHideTimer); tipHideTimer = null; }
            hideTip();
        }

        // Restart tips when settings change (simple restart without resetting defaults)
        function restartTips() {
            stopTipsLoop();
            if (userSettings.tipsEnabled) startTipsLoop();
        }

        // Initialize application state, load settings/auth and attach event listeners
        function init() {
            // load saved language and auth
            const savedLang = localStorage.getItem('selectedLanguage') || currentLang;
            const savedAuth = localStorage.getItem('authState');
            if (savedAuth) {
                try {
                    authState = JSON.parse(savedAuth);
                } catch (e) {
                    authState = { user: null, mode: null };
                }
            }

            // Apply language and settings
            updatePageLanguage(savedLang);
            const langSel = document.getElementById('langSel');
            if (langSel) langSel.value = savedLang;

            // Load user settings and apply theme/fonts
            loadUserSettings();
            updateAuthButton();
            applyTheme(userSettings.theme || 'dark');

            // Wire up primary controls
            const authBtn = document.getElementById('authBtn');
            if (authBtn) authBtn.addEventListener('click', () => {
                if (authState.user || authState.mode === 'guest') handleLogout(); else openAuthModal();
            });

            if (langSel) langSel.addEventListener('change', (e) => {
                updatePageLanguage(e.target.value);
                loadConfig();
            });

            const authModal = document.getElementById('authModal');
            if (authModal) authModal.addEventListener('click', (e) => { if (e.target.id === 'authModal') closeAuthModal(); });

            // Wire up floating icon buttons
            const iconBtns = {
                'icon-budget': 'budget-popup',
                'icon-design': 'design-popup',
                'icon-language': 'language-popup',
                'icon-notifications': 'notifications-popup',
                'icon-tips': 'tips-popup',
                'icon-account': 'account-popup'
            };
            
            Object.entries(iconBtns).forEach(([btnId, popupId]) => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openPopup(popupId);
                    });
                }
            });

            // Close popups when clicking outside
            document.addEventListener('click', (e) => {
                const isPopupClick = e.target.closest('.settings-popup');
                const isIconClick = e.target.closest('.icon-btn');
                if (!isPopupClick && !isIconClick) {
                    closeAllPopups();
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeBudgetPanel();
                    closeAddTransactionModal();
                    closeAllPopups();
                }
            });

            const tipsToggleEl = document.getElementById('tipsToggle');
            if (tipsToggleEl) tipsToggleEl.addEventListener('click', () => { setTipsEnabled(!userSettings.tipsEnabled); });

            // Attach add-transaction button handler (defensive)
            const txAddBtn = document.getElementById('txAddBtn');
            if (txAddBtn) txAddBtn.addEventListener('click', addTransactionFromUI);
            renderCurrencyList2();
            renderNotificationHistory();
            renderTipList();
            // loadConfig() - disabled for offline-first mode
        }

        async function loadConfig() {
            try{
                const res = await fetch('/config', { signal: AbortSignal.timeout(3000) });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const cfg = await res.json();
                const banner = document.getElementById('configBanner');
                const t = translations[currentLang];
                if(!cfg.hasKeys){
                    banner.innerHTML = t.configNotSet;
                } else {
                    banner.innerHTML = t.configDetected;
                }
            }catch(e){
                const b = document.getElementById('configBanner');
                const t = translations[currentLang];
                // Silently hide banner if server not running
                if (e.name === 'AbortError' || e.message.includes('Failed to fetch')) {
                    b.style.display = 'none';
                } else {
                    b.textContent = t.configError + e.message;
                }
            }
        }

        init();
    </script>
</body>
</html>